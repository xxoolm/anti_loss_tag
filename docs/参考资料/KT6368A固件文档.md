# KT6368A 固件开发文档

> 基于 KT6368A 定制固件的通用 Python 开发指南

## 1. 业务目标与边界

### 1.1 核心功能

| 功能         | 说明                                      |
| ------------ | --------------------------------------- |
| 发现设备       | 基于服务 UUID (FFE0) 扫描过滤，短时扫描（5秒）            |
| 连接与服务发现    | 连接后立即做 GATT 服务发现，缓存关键特征值句柄               |
| 即时报警控制     | 让设备"立刻响/立刻停"（写入 2A06）                      |
| 断开报警策略     | 同步"断开是否报警"策略到设备（写入 FFE2）                  |
| 按钮事件上报     | 设备按键触发通知上报（FFE1），客户端解析后触发本地动作              |
| 电量读取       | 连接后读取电量（2A19）并持久化                         |
| RSSI 轮询    | 连接后读取信号强度并持久化                             |
| 断线处理       | 断开后自动重连 + 条件满足时触发本地报警（考虑 Wi-Fi 勿扰、勿扰时段） |

### 1.2 约束条件

- **前置条件检查**：GPS、蓝牙开关必须开启
- **设备数量上限**：建议限制到 8 个设备
- **"我的设备"概念**：扫描时清理非"我的设备"条目

---

## 2. BLE 协议要点

### 2.1 UUID 总表

| UUID                                 | 类型                 | 语义                                    |
| ------------------------------------ | ------------------ | ------------------------------------- |
| 0000FFE0-0000-1000-8000-00805F9B34FB | Service            | 扫描过滤服务（用于 ScanFilter）                  |
| 0000FFE1-0000-1000-8000-00805F9B34FB | Characteristic     | 通知/上报通道（按键等事件上报）                      |
| 0000FFE2-0000-1000-8000-00805F9B34FB | Characteristic     | 断开报警策略写入（0x01=启用、0x00=关闭）               |
| 00002A06-0000-1000-8000-00805F9B34FB | Alert Level        | 即时报警控制（0x01=开始、0x00=停止）               |
| 00002A19-0000-1000-8000-00805F9B34FB | Battery Level      | 电量读取（0-100）                           |

### 2.2 数据语义

**FFE1 通知通道**：
- 字节流
- 首字节为 1 代表一次按键事件
- 需要开启通知后才能接收

**FFE2 断开策略**：
- 写入 0x01 启用断开报警
- 写入 0x00 关闭断开报警

**2A06 即时报警**：
- 写入 0x01 开始报警
- 写入 0x00 停止报警

**2A19 电量**：
- 读取返回 0-100 百分比
- 建议 1 字节表示

---

## 3. 架构拆解（Python 映射）

### 3.1 组件划分

#### 1. Device Registry（设备注册表）
- 维护 MAC → 设备记录映射
- 包含连接对象、特征值引用、重连计数

#### 2. BLE Manager（BLE 管理）
- **扫描**：短时扫描 + serviceUuid 过滤
- **连接**：按 MAC 连接
- **服务发现**：遍历所有服务与特征并缓存关键 UUID

#### 3. Policy Engine（策略层）
断开报警判断顺序：
1. 设备级"断开报警开关"
2. 全局 Wi-Fi 勿扰开关
3. 全局勿扰时段开关/时间窗口

#### 4. Persistence（持久化）
- 启动时加载设备列表
- 保存连接状态、按钮文案、重连计数

#### 5. Event Bus（事件与通知）
- 连接/断开触发弹窗
- FFE1 通知触发按键事件

---

## 4. 数据模型

### 4.1 设备记录（最小字段集）

```python
@dataclass
class BleDevice:
    # 标识
    mac: str                                    # MAC 地址（主键）
    name: str                                   # 展示名

    # 归属与展示
    is_mine: bool                               # 是否"我的设备"
    ui_button_state: str                        # 按钮展示状态

    # 连接与告警
    is_connected: bool                          # 是否已连接
    is_alarming: bool                           # 是否处于报警态
    alarm_on_disconnect: bool                   # 断开是否报警
    ring_index: int                             # 铃声选择

    # 信号与电量
    battery_level: int                          # 电量百分比（0-100）
    rssi: int                                   # 信号强度

    # 时间与审计
    last_seen: datetime                         # 最近扫描时间
    last_disconnect_time: datetime              # 最近断开时间

    # GATT 运行态（不持久化）
    gatt_connection_ref: Optional[Any]          # 连接对象引用
    char_alert_level_ref: Optional[Any]         # 2A06 特征引用
    char_notify_ref: Optional[Any]              # FFE1 特征引用
    char_disconnect_policy_ref: Optional[Any]   # FFE2 特征引用
```

---

## 5. 核心流程（状态机）

### 5.1 启动初始化

```
1. 初始化全局工具与用户设置
2. 从本地 DB 加载所有已保存设备
3. 建立设备映射，置为未连接
4. 启动 BLE 扫描
```

### 5.2 扫描发现

```
1. 前置条件检查（GPS、蓝牙）
2. 扫描前清理非"我的设备"
3. 启动扫描（FFE0 过滤）
4. 5秒后自动停止
```

### 5.3 连接与服务发现

```
1. 按设备优先级连接
2. 连接成功 → 服务发现
3. 缓存关键特征（2A06、FFE1、FFE2、2A19）
4. 开启 FFE1 通知
5. 读取电量
6. 写入断开策略
7. 上报服务器
```

### 5.4 断开处理

```
1. 标记设备未连接
2. 判断是否满足报警条件：
   - 设备级开关开启？
   - Wi-Fi 勿扰关闭？
   - 不在勿扰时段？
3. 满足条件 → 播放报警
4. 启动自动重连
```

---

## 6. Python 实现要点

### 6.1 扫描策略

```python
# 建议参数
SCAN_DURATION = 5  # 秒
SCAN_UUID = "0000FFE0-0000-1000-8000-00805F9B34FB"
SCAN_MODE = "LOW_LATENCY"  # 快速发现
```

### 6.2 特征缓存

```python
# 服务发现后立即缓存
characteristics = {
    "alert_level": service.get_characteristic("00002A06..."),
    "notify": service.get_characteristic("0000FFE1..."),
    "disconnect_policy": service.get_characteristic("0000FFE2..."),
    "battery": service.get_characteristic("00002A19...")
}
```

### 6.3 通知处理

```python
def on_notification_handler(sender, data):
    if data[0] == 1:
        # 按钮事件
        trigger_button_event()
```

### 6.4 多级勿扰判断

```python
def should_alarm(device):
    if not device.alarm_on_disconnect:
        return False
    if wifi_connected and global_wifi_dnd:
        return False
    if current_time_in_dnd_period():
        return False
    return True
```

---

## 7. 与硬件文档的关联

本文档是**固件逻辑**的 Python 实现，配合以下文档使用：

- **KT6368A 硬件文档**：硬件规格、引脚定义、电路设计
- **硬件开发文档（SOP-8）**：封装、引脚、时钟设计

---

## 8. 参考资源

- 原始文档：`archive/reference_docs/KT6368A 定制固件 通用 Python 开发文档.md`
- BLE 协议规范：`docs/技术文档/BLE协议规范.md`
- 架构设计：`docs/技术文档/系统架构设计.md`
- Java 参考实现：`docs/Java参考/Java代码审核.md`
