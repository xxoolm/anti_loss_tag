# 系统架构设计

> **Home Assistant BLE 防丢标签集成 - 完整架构说明**

## 一、系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      Home Assistant Core                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Anti Loss Tag Integration                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Config Flow (配置流程)                   │   │
│  │  - 用户输入配置                                        │   │
│  │  - 扫描并选择设备                                      │   │
│  │  - 创建配置条目                                        │   │
│  └──────────────────────────────────────────────────────┘   │
│                              │                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │           Coordinator (协调器)                        │   │
│  │  - 初始化/清理                                         │   │
│  │  - 生命周期管理                                        │   │
│  │  - 事件路由                                            │   │
│  └──────────────────────────────────────────────────────┘   │
│                              │                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │           BLE Device Manager                          │   │
│  │  ┌──────────────┐  ┌──────────────┐                  │   │
│  │  │  设备注册表   │  │  连接管理器   │                  │   │
│  │  │  DeviceMap   │  │  GATTManager │                  │   │
│  │  └──────────────┘  └──────────────┘                  │   │
│  │  ┌──────────────┐  ┌──────────────┐                  │   │
│  │  │  扫描管理器   │  │  重连管理器   │                  │   │
│  │  │  Scanner     │  │  Reconnector │                  │   │
│  │  └──────────────┘  └──────────────┘                  │   │
│  └──────────────────────────────────────────────────────┘   │
│                              │                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │           BLE Device (单个设备)                        │   │
│  │  ┌────────────────────────────────────────────────┐  │   │
│  │  │  - 状态机（Disconnected/Connecting/Connected） │  │   │
│  │  │  - GATT 操作封装                                │  │   │
│  │  │  - 特征值管理（FFE1/FFE2/2A06/2A19）           │  │   │
│  │  │  - 数据解析（电量/按钮事件/RSSI）               │  │   │
│  │  └────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────┘   │
│                              │                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │           Entities (实体层)                           │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐             │   │
│  │  │ 传感器    │ │二进制传感器│ │  按钮实体  │             │   │
│  │  │电量/RSSI │ │连接状态   │ │双击事件   │             │   │
│  │  └──────────┘ └──────────┘ └──────────┘             │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    External Services                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ bleak (BLE库) │  │ Bluetooth    │  │ 用户自动化   │      │
│  │              │  │ Adapters     │  │              │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

## 二、核心模块说明

### 2.1 Config Flow（配置流程）

**职责**：
- 引导用户完成设备添加
- 扫描并列出可用设备
- 创建配置条目

**关键流程**：
```
用户触发
  ↓
显示配置表单
  ↓
扫描设备（5秒，FFE0过滤）
  ↓
用户选择设备
  ↓
创建配置条目
  ↓
触发设备添加
```

---

### 2.2 Coordinator（协调器）

**职责**：
- 集成的生命周期管理（async_setup_entry/async_unload_entry）
- 全局状态管理
- 事件路由和分发

**关键方法**：
- `async_setup_entry`：初始化集成，加载配置，创建设备
- `async_unload_entry`：清理资源，断开连接
- `async_handle_event`：处理设备事件（按钮、连接、断开）

---

### 2.3 BLE Device Manager（设备管理器）

**职责**：
- 维护全局设备注册表（MAC地址→设备实例）
- 扫描管理（短时扫描、UUID过滤）
- 连接管理（避免重复连接）
- 重连管理（指数退避）

**数据结构**：
```python
device_map: dict[str, BLEDevice]        # MAC地址→设备实例
client_map: dict[str, BleakClient]      # MAC地址→GATT客户端
reconnect_tasks: dict[str, asyncio.Task] # MAC地址→重连任务
```

---

### 2.4 BLE Device（单个设备）

**职责**：
- 设备状态机（Disconnected/Connecting/Connected/Alarming）
- GATT 操作封装（连接、断开、读写特征值）
- 特征值管理（FFE1/FFE2/2A06/2A19）
- 数据解析（电量、按钮事件、RSSI）

**状态机**：
```
Disconnected
    ↓ (用户触发/自动重连)
Connecting
    ↓ (连接成功)
Connected
    ↓ (检测到断开)
Disconnected (触发重连)
```

**关键方法**：
- `async_connect`：连接设备，服务发现，开启通知
- `async_disconnect`：断开连接，清理资源
- `async_write_alarm_policy`：写入断开报警策略（FFE2）
- `async_trigger_alarm`：触发即时报警（2A06）
- `async_read_battery`：读取电量（2A19）
- `async_start_rssi_polling`：开始 RSSI 轮询

---

### 2.5 Entities（实体层）

**职责**：
- 向 Home Assistant 暴露设备状态
- 提供自动化触发点

**实体类型**：
1. **Sensor（传感器）**
   - `sensor.xxx_battery_level`：电量百分比
   - `sensor.xxx_rssi`：信号强度
   - `sensor.xxx_last_seen`：最后连接时间

2. **Binary Sensor（二进制传感器）**
   - `binary_sensor.xxx_connected`：连接状态
   - `binary_sensor.xxx_alarming`：报警状态

3. **Button（按钮）**
   - `button.xxx_trigger_alarm`：触发报警

4. **Event（事件）**
   - `anti_loss_tag_button_pressed`：按钮事件

---

## 三、数据流

### 3.1 设备添加流程

```
Config Flow
  ↓
扫描设备（Scanner）
  ↓
用户选择
  ↓
创建 ConfigEntry
  ↓
Coordinator.async_setup_entry
  ↓
BLEDeviceManager.async_add_device
  ↓
BLEDevice.async_connect
  ↓
服务发现 + 开启通知
  ↓
创建 Entities
  ↓
设备就绪
```

### 3.2 按钮事件流程

```
设备按键
  ↓
FFE1 通知上报
  ↓
BLEDevice._on_characteristic_changed
  ↓
解析数据（value[0] == 1）
  ↓
Coordinator.async_handle_event
  ↓
HASS.bus.fire("anti_loss_tag_button_pressed")
  ↓
用户自动化触发
```

### 3.3 断开报警流程

```
连接断开
  ↓
BLEDevice._on_disconnected
  ↓
检查 alarm_on_disconnect 开关
  ↓
检查勿扰条件（Wi-Fi/时间）
  ↓
满足条件 → BLEDevice.async_trigger_alarm
  ↓
写入 2A06 (0x01)
  ↓
设备报警
  ↓
启动重连任务
```

---

## 四、关键技术决策

### 4.1 为什么使用 `local_push` IoT 类别？

**理由**：
- 设备通过 FFE1 通知**主动推送**按钮事件
- 电量/RSSI 虽然需要轮询，但**核心事件是推送的**
- 符合"设备主动通知"的定义

**对比 `local_polling`**：
- `local_polling`：需要持续轮询才能获取状态（延迟高）
- `local_push`：设备主动通知，延迟低

---

### 4.2 为什么使用 `device` 集成类型？

**理由**：
- 每个防丢标签是**独立的设备**
- 不是集线器架构（如 Philips Hue）
- 符合"提供单个设备"的定义

---

### 4.3 为什么使用 `bluetooth_adapters` 依赖？

**理由**：
- 需要 **BLE 扫描功能**（发现设备）
- 需要 **RSSI 监控**（距离判断）
- 官方推荐的 BLE 集成最佳实践

---

## 五、并发模型

### 5.1 异步架构

整个集成基于 **asyncio**，所有阻塞操作都是异步的：
- BLE 连接/断开
- GATT 读写
- 扫描操作
- RSSI 轮询

### 5.2 锁机制

为了保护关键操作，使用了以下锁：
- `_gatt_lock`：保护 GATT 操作（避免并发写入）
- `_connect_lock`：保护连接/断开操作
- `_reconnect_lock`：保护重连逻辑

**注意事项**：
- 不要在持有锁时执行耗时操作
- 避免死锁（嵌套锁）

---

## 六、错误处理策略

### 6.1 连接失败

- **指数退避重连**：初始间隔 5 秒，最大 60 秒
- **最大重试次数**：无限重试（用户可配置）
- **失败上报**：记录日志，更新实体状态

### 6.2 GATT 操作失败

- **写入失败**：重试 3 次，仍失败则重新连接
- **读取失败**：延迟重试
- **特征值不存在**：记录日志，禁用相关功能

### 6.3 设备离线

- **自动重连**：检测到断开后立即启动重连
- **报警策略**：根据配置决定是否触发断开报警
- **状态同步**：更新所有实体状态为不可用

---

## 七、性能优化

### 7.1 连接池管理

- 每个 MAC 地址只维护一个 BleakClient
- 避免重复连接（检查 `is_connected`）
- 定期清理僵尸连接

### 7.2 扫描优化

- **短时扫描**：5 秒后自动停止
- **UUID 过滤**：只扫描 FFE0 服务
- **延迟启动**：扫描前延迟 200ms（等待蓝牙就绪）

### 7.3 资源管理

- **特征值缓存**：服务发现后缓存特征值引用
- **通知复用**：只开启一次 FFE1 通知
- **任务清理**：unload 时取消所有后台任务

---

## 八、安全考虑

### 8.1 数据验证

- **MAC 地址格式验证**：`^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$`
- **电量范围检查**：0-100
- **RSSI 范围检查**：-100 到 0

### 8.2 权限控制

- 蓝牙扫描权限检查
- 蓝牙连接权限检查
- 位置权限检查（某些系统需要）

---

## 九、扩展性设计

### 9.1 支持新设备

添加新设备只需：
1. 确认设备 UUID（FFE0/FFE1/FFE2/2A06/2A19）
2. 调整数据解析逻辑（如果协议不同）
3. 添加配置选项（设备特定参数）

### 9.2 自定义功能

扩展点：
- **自定义数据解析**：重写 `parse_notification_data`
- **自定义报警策略**：重写 `check_disconnect_alarm`
- **自定义自动化**：监听 `anti_loss_tag_button_pressed` 事件

---

## 十、参考资源

- **BLE 协议规范**：`docs/technical/ble-protocol.md`
- **开发规范**：`docs/technical/development.md`
- **代码审查**：`docs/technical/code-review.md`
- **Java 参考**：`docs/java/code-review.md`
