# BLE 防丢标签 - 快速参考卡片

**版本**: v1.0.0 | **最后更新**: 2025-02-06

---

## BLE UUID 速查表

| UUID | 类型 | 用途 | 写入数据 |
|------|------|------|----------|
| `0000FFE0` | Service | 扫描过滤 | - |
| `0000FFE1` | Characteristic | 通知上报 | - |
| `0000FFE2` | Characteristic | 断开报警策略 | `0x01`=开启, `0x00`=关闭 |
| `00002A06` | Characteristic | 即时报警 | `0x01`=开始, `0x00`=取消 |
| `00002A19` | Characteristic | 电量读取 | - |

**核心规则**:
1. 先连接 → 服务发现 → 再写 FFE2/2A06
2. 一次只写一条，等回调再写下一条
3. 以回调 status 为准，不看提交成功

---

## 常用配置参数

| 参数 | 默认值 | 范围 | 说明 |
|------|--------|------|------|
| 维持连接 | 开启 | 开/关 | 保持持续连接 |
| 电量轮询间隔 | 60 分钟 | 5-10080 | 电量读取频率 |
| RSSI 轮询间隔 | 5 分钟 | 1-60 | 信号强度读取频率 |
| RSSI 阈值 | -80 dBm | -100 to -50 | 远离告警阈值 |
| 超时阈值 | 30 秒 | 5-120 | 连接超时时间 |

---

## 实体类型

### 传感器 (Sensor)
- `{设备名} 电量` - 0-100%
- `{设备名} 信号强度` - dBm
- `{设备名} 最后错误` - 错误信息

### 二进制传感器 (Binary Sensor)
- `{设备名} 连接状态` - on/off
- `{设备名} 可用状态` - on/off
- `{设备名} 远离告警` - on/off
- `{设备名} 防丢状态` - on/off

### 按钮 (Button)
- `{设备名} 铃声开关` - 切换设备铃声
- `{设备名} 防丢开关` - 切换防丢功能

### 事件 (Event)
- `{设备名} 按钮事件` - single_click, double_click, long_press

---

## 常见自动化示例

### 设备远离提醒

```yaml
automation:
  - alias: "标签远离提醒"
    trigger:
      - platform: state
        entity_id: binary_sensor.my_tag_far_away
        to: "on"
    action:
      - service: notify.mobile_app_my_phone
        data:
          title: "防丢提醒"
          message: "标签已远离！"
```

### 双击打开灯

```yaml
automation:
  - alias: "双击标签打开客厅灯"
    trigger:
      - platform: event
        event_type: anti_loss_tag_button_event
        event_data:
          device_id: "AA:BB:CC:DD:EE:FF"
          click_type: double_click
    action:
      - service: light.turn_on
        target:
          entity_id: light.living_room
```

### 电量低提醒

```yaml
automation:
  - alias: "标签电量低提醒"
    trigger:
      - platform: numeric_state
        entity_id: sensor.my_tag_battery
        below: 20
    action:
      - service: notify.mobile_app_my_phone
        data:
          title: "标签电量低"
          message: "电量仅剩 20%，请及时充电！"
```

---

## 故障排除速查

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 设备无法连接 | 蓝牙未开启/不在范围内 | 检查设备蓝牙和距离 |
| 连接频繁断开 | 电量不足/信号干扰 | 增加超时阈值，减少并发设备 |
| 电量不更新 | 维持连接未开启 | 检查配置选项 |
| 按钮无响应 | FFE1通知未开启 | 查看日志确认通知状态 |

### 启用调试日志

```yaml
logger:
  default: info
  logs:
    custom_components.anti_loss_tag: debug
    bleak: debug
```

### 重载集成

**服务调用**:
```yaml
service: homeassistant.reload_config_entry
data:
  entry_id: "你的entry_id"
```

---

## 开发者速查

### 代码规范要点

```python
# 1. 导入顺序
from __future__ import annotations

# 标准库
import asyncio
import logging

# 第三方库
from homeassistant.config_entries import ConfigEntry

# 本地模块
from .const import DOMAIN

# 2. 类型注解（必须）
async def async_setup_entry(hass: HomeAssistant, entry: ConfigEntry) -> bool:
    """函数必须有 docstring 和类型注解。"""
    pass

# 3. 命名约定
# 类名: PascalCase
# 函数: snake_case
# 私有: _前缀
# 常量: UPPER_SNAKE_CASE
```

### 关键文件位置

| 文件 | 行数 | 说明 |
|------|------|------|
| `device.py` | 709 | 设备管理（需重构） |
| `connection_manager.py` | - | 连接管理器 |
| `config_flow.py` | - | 配置流程 |
| `sensor.py` | - | 传感器实体 |

### P0 严重问题

1. **缩进错误**: `device.py:352-358` - 修复缩进
2. **文件混乱**: 根目录临时文件 - 已在.gitignore

### P1 重要问题

1. 连接槽位泄漏风险
2. _gatt_lock 可能死锁
3. 缺少 strings.json
4. 重复 import 语句

 注：manifest.json 缺少字段问题已在 v1.0.0 修复

---

## KT6368A 硬件速查

### 引脚定义（SOP-8）

| 引脚 | 名称 | 功能 |
|------|------|------|
| 1 | VBAT | 电源（2.2-3.4V，不超过3.6V） |
| 2 | PB1 | GPIO/蜂鸣器 |
| 3 | VSS | GND |
| 4 | BT_RF | 天线 |
| 5 | BTOSCI | 晶振输入 |
| 6 | BTOSCO | 晶振输出 |
| 7 | USBDM | GPIO/LED |
| 8 | USBDP | GPIO/按键 |

### 关键参数

- **供电**: 3.3V 推荐，范围 2.2-3.4V
- **电流**: 启动 26mA，低功耗 20µA
- **晶体**: 外接高频晶振到 Pin5/6
- **RF**: Pin4 单端天线，匹配 2.7pF 或 0Ω

### 产测要点

1. 供电边界: 2.2-3.4V（不>3.6V）
2. 晶体起振验证
3. RF 性能测试
4. 低功耗 IO 高阻验证
5. AT 写入流程（波特率 115200）

---

## 文档导航

| 文档 | 用途 |
|------|------|
| [README.md](README.md) | 用户文档，安装配置 |
| [uuid.md](uuid.md) | BLE 协议详解 |
| [CODE_REVIEW.md](CODE_REVIEW.md) | 代码审查报告 |
| [AGENTS.md](AGENTS.md) | 开发规范手册 |
| [TECHNICAL_REFERENCE.md](TECHNICAL_REFERENCE.md) | **完整技术参考** |
| [DOCS_INDEX.md](DOCS_INDEX.md) | 文档索引 |

---

## 快速链接

- **GitHub**: https://github.com/xxoolm/anti_loss_tag
- **问题反馈**: https://github.com/xxoolm/anti_loss_tag/issues
- **Home Assistant 文档**: https://www.home-assistant.io/docs/

---

**提示**: 完整技术信息请查看 [TECHNICAL_REFERENCE.md](TECHNICAL_REFERENCE.md)

**版本**: v1.0.0 | **许可证**: MIT
