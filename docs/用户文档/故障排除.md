# 故障排除

本文档帮助您诊断和解决使用 BLE 防丢标签集成时遇到的常见问题。

## 目录

- [安装问题](#安装问题)
- [连接问题](#连接问题)
- [数据更新问题](#数据更新问题)
- [自动化问题](#自动化问题)
- [性能问题](#性能问题)
- [诊断工具](#诊断工具)

---

## 安装问题

### 集成未出现在列表中

**现象**：在"添加集成"中找不到"BLE 防丢标签"

**可能原因**：
1. 文件未正确复制到 `custom_components` 目录
2. Home Assistant 未重启
3. manifest.json 格式错误

**解决方法**：

1. 检查文件结构：
```bash
ls -R ~/.homeassistant/custom_components/anti_loss_tag/
```

应该看到：
```
__init__.py
manifest.json
config_flow.py
device.py
sensor.py
binary_sensor.py
button.py
```

2. 检查日志：
- 进入"设置" → "系统" → "日志"
- 搜索错误关键词：`anti_loss_tag`

3. 重启 Home Assistant：
```bash
sudo systemctl restart home-assistant@your_user
```

---

### manifest.json 错误

**现象**：日志显示 `manifest.json` 格式错误

**检查方法**：
```bash
cat ~/.homeassistant/custom_components/anti_loss_tag/manifest.json | python3 -m json.tool
```

**常见错误**：
- 缺少逗号
- 缺少引号
- 使用了单引号而不是双引号

**解决方法**：
参考 [manifest.json 2025标准](../reference/manifest-2025.md) 检查格式

---

## 连接问题

### 扫描不到设备

**现象**：配置向导中扫描不到设备

**诊断步骤**：

1. **确认设备已开启**：
   - 检查设备电池是否有电
   - 长按设备按钮确认设备工作

2. **检查蓝牙适配器**：
   ```bash
   hciconfig -a
   ```
   应该看到蓝牙适配器信息

3. **检查 Home Assistant 蓝牙**：
   - 进入"设置" → "系统" → "硬件"
   - 查看"蓝牙"部分是否检测到适配器

4. **手动扫描测试**：
   ```bash
   sudo hcitool lescan
   ```

**解决方法**：

1. 重启蓝牙适配器：
```bash
sudo bluetoothctl
power off
power on
```

2. 将设备靠近适配器（1米内）

3. 确认设备支持 BLE（不是经典蓝牙）

---

### 连接失败

**现象**：设备显示"连接中"然后断开

**可能原因**：
1. 设备被其他应用占用（手机已连接）
2. 信号太弱
3. 设备不支持 GATT 连接

**诊断步骤**：

1. **检查设备是否被占用**：
   - 关闭手机蓝牙
   - 卸载手机上的防丢标签App
   - 重试连接

2. **检查信号强度**：
   - 将设备靠近蓝牙适配器（0.5米内）
   - 避开金属障碍物

3. **查看日志**：
   ```
   grep -i "bleak\|gatt\|connection" home-assistant.log | tail -50
   ```

**解决方法**：

1. 重置设备：
   - 取出电池
   - 等待10秒
   - 重新安装电池

2. 更换蓝牙适配器（推荐USB蓝牙5.0适配器）

3. 增加 `timeout_seconds` 参数到 60

---

### 频繁断开重连

**现象**：设备状态在"已连接"和"未连接"之间频繁切换

**可能原因**：
1. RSSI 阈值设置过低
2. 超时设置过短
3. 蓝牙适配器不稳定
4. 设备电量低

**诊断步骤**：

1. **查看RSSI值**：
   - 进入"开发者工具" → "状态"
   - 查看 `sensor.{设备名}_rssi` 的值
   - 正常范围：-50 到 -90 dBm

2. **检查日志**：
   ```bash
   grep "disconnected\|connected" home-assistant.log | tail -20
   ```

**解决方法**：

1. **调整RSSI阈值**：
   - 将 `rssi_threshold` 调整到 -85 或 -90

2. **增加超时时间**：
   - 将 `timeout_seconds` 增加到 60 或 90

3. **关闭其他蓝牙设备**：
   - 减少同时连接的BLE设备数量

4. **更换蓝牙适配器**：
   - 使用品牌适配器（如ASUS、TP-Link）

---

## 数据更新问题

### 电量不更新

**现象**：电量传感器一直显示"未知"或固定值

**诊断步骤**：

1. **检查维持连接**：
   - 确认 `maintain_connection` 已开启

2. **检查电量轮询间隔**：
   - 确认 `battery_poll_interval_min` 未设置过大

3. **手动触发读取**：
   - 重启集成
   - 观察日志中是否有"读取电量"信息

**解决方法**：

1. 减少 `battery_poll_interval_min` 到 60

2. 确认设备支持电量读取：
```bash
# 查看日志中的服务发现
grep "2A19\|battery" home-assistant.log
```

3. 如果设备不支持电量读取，电量传感器将显示"未知"

---

### RSSI不更新

**现象**：信号强度一直显示固定值

**诊断步骤**：

1. **检查RSSI轮询间隔**：
   - 确认 `rssi_poll_interval_min` 已设置

2. **移动设备测试**：
   - 将设备从近到远移动
   - 观察RSSI值是否变化

**解决方法**：

1. 确保 `maintain_connection` 已开启

2. 减少 `rssi_poll_interval_min` 到 2 或 5

3. 检查日志：
```bash
grep "rssi\|signal" home-assistant.log | tail -20
```

---

### 按钮事件不触发

**现象**：双击/单击设备按钮，Home Assistant中无事件

**诊断步骤**：

1. **确认通知已开启**：
   - 查看日志中是否有"start_notify FFE1"信息

2. **测试按钮**：
   - 快速双击设备按钮（2次点击间隔<0.5秒）

3. **查看事件**：
   - 进入"开发者工具" → "事件"
   - 监听 `anti_loss_tag_button_event`

**解决方法**：

1. 确保 `maintain_connection` 已开启（必需）

2. 检查设备是否支持按钮事件：
```bash
grep "FFE1\|button" home-assistant.log
```

3. 尝试不同的按钮操作：
   - 单击：快速按1次
   - 双击：快速按2次
   - 长按：按住2秒

---

## 自动化问题

### 自动化未触发

**现象**：设置了自动化，但条件满足时未执行

**诊断步骤**：

1. **检查实体ID**：
   - 进入"开发者工具" → "状态"
   - 确认实体名称正确（如 `binary_sensor.my_tag_far_away`）

2. **检查触发器**：
   - 确认触发器条件正确
   - 测试：手动改变触发器状态

3. **查看自动化日志**：
   ```bash
   grep "automation" home-assistant.log | grep "标签"
   ```

**解决方法**：

1. **在自动化中添加调试**：
```yaml
automation:
  - alias: "调试标签远离"
    trigger:
      - platform: state
        entity_id: binary_sensor.my_tag_far_away
        to: "on"
    action:
      - service: logbook.log
        data:
          message: "标签远离自动化已触发"
```

2. **检查条件**：
   - 移除所有 `condition` 测试
   - 逐步添加条件找出问题

3. **检查服务调用**：
   - 确认 `service:` 名称正确
   - 测试：在"开发者工具" → "服务"中手动调用

---

## 性能问题

### Home Assistant变慢

**现象**：添加多个标签后，Home Assistant响应变慢

**可能原因**：
1. 同时连接设备过多
2. 轮询间隔过短
3. 蓝牙适配器性能不足

**解决方法**：

1. **减少同时连接数**：
   - 关闭部分设备的 `maintain_connection`
   - 将 `battery_poll_interval_min` 增加到 240

2. **优化轮询间隔**：
   - `rssi_poll_interval_min`: 10
   - `battery_poll_interval_min`: 480

3. **更换高性能蓝牙适配器**：
   - 推荐支持蓝牙5.0的适配器
   - 支持多连接的适配器

---

### 设备电量消耗快

**现象**：标签电池续航时间很短（几天内耗尽）

**可能原因**：
1. 轮询过于频繁
2. 始终保持连接

**解决方法**：

1. **增加轮询间隔**：
   - `battery_poll_interval_min`: 480（8小时）
   - `rssi_poll_interval_min`: 15

2. **关闭维持连接**（如果不需要按钮事件）：
   - `maintain_connection`: false

3. **调整RSSI阈值**：
   - `rssi_threshold`: -85（减少不必要的通信）

---

## 诊断工具

### 查看日志

**位置**："设置" → "系统" → "日志"

**关键字搜索**：
- `anti_loss_tag` - 集成相关
- `bleak` - BLE库相关
- `connection` - 连接相关
- `FFE1` / `FFE2` - UUID相关
- `button` - 按钮事件相关

### 实体状态检查

**位置**："开发者工具" → "状态"

**关键实体**：
- `binary_sensor.{设备名}_connected` - 连接状态
- `sensor.{设备名}_battery` - 电量
- `sensor.{设备名}_rssi` - 信号强度
- `binary_sensor.{设备名}_far_away` - 远离检测

### 手动服务调用

**位置**："开发者工具" → "服务"

**测试连接**：
```yaml
服务: bluetooth_adapters.start_bleak_client
设备ID: AA:BB:CC:DD:EE:FF
```

### 查看事件

**位置**："开发者工具" → "事件"

**监听按钮事件**：
```
anti_loss_tag_button_event
```

---

## 获取帮助

如果以上方法无法解决您的问题：

1. **收集诊断信息**：
   - 日志文件
   - 实体状态截图
   - 配置参数
   - Home Assistant版本

2. **提交Issue**：
   - GitHub: [项目地址]
   - 描述问题现象
   - 附上诊断信息

3. **社区求助**：
   - Home Assistant社区论坛
   - 附上日志和配置

---

**下一步**：[快速开始](getting-started.md) | [配置指南](configuration.md)
