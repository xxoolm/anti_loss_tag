# 快速开始

本指南将帮助您快速安装和配置 Home Assistant BLE 防丢标签集成。

## 前置要求

### 硬件要求
- BLE 防丢标签设备（支持 KT6368A 芯片或兼容设备）
- 蓝牙 USB 适配器（如果主机没有内置蓝牙）

### 软件要求
- bleak >= 0.21.0
- bleak-retry-connector >= 3.0.0

### 蓝牙适配器要求
推荐使用支持蓝牙 5.0+ 的适配器，兼容性更好。

## 安装方法

### 方法1：通过 HACS 安装（推荐）

1. 在 Home Assistant 中打开 HACS
2. 点击"商店"
3. 搜索"anti_loss_tag"
4. 点击下载并安装
5. 重启 Home Assistant

### 方法2：手动安装

1. 创建目录：
```bash
cd /path/to/homeassistant/config
mkdir -p custom_components/anti_loss_tag
```

2. 下载集成文件：
```bash
cd custom_components/anti_loss_tag
# 复制集成的所有文件到此目录
```

3. 文件清单：
- `__init__.py` - 集成入口
- `manifest.json` - 集成清单
- `strings.json` - 本地化字符串
- `config_flow.py` - 配置流程
- `device.py` - 设备管理
- `const.py` - 常量定义
- `coordinator.py` - 数据协调器
- `ble.py` - BLE GATT 操作
- `sensor.py` - 传感器实体
- `binary_sensor.py` - 二进制传感器实体
- `button.py` - 按钮实体
- `switch.py` - 开关实体
- `event.py` - 事件实体
- `connection_manager.py` - 连接管理器
- `java_inspired.py` - Java 参考实现

4. 重启 Home Assistant

## 首次配置

### 1. 添加集成

1. 在 Home Assistant 中，进入"设置" → "设备与服务"
2. 点击"添加集成"
3. 搜索"BLE 防丢标签"或"anti_loss_tag"
4. 点击添加

### 2. 扫描设备

1. 集成会自动扫描附近的 BLE 设备
2. 在扫描到的设备列表中选择您的防丢标签
3. 设备名称通常格式为"Tag_XXXXXX"（XXXXXX为MAC地址后6位）

### 3. 配置参数

配置向导会提示您设置以下参数：

#### 必需参数
- **设备名称**：给设备起一个易识别的名称（如"我的钥匙"）

#### 可选参数

- **断连报警**：断开连接时是否触发设备蜂鸣器报警
  - 默认：关闭
  - 推荐：关闭（避免干扰）

- **维持连接**：是否保持与设备的持续连接
  - 默认：开启
  - 推荐：开启（用于实时监控和按钮事件）

- **自动重连**：连接断开后是否自动重连
  - 默认：开启
  - 推荐：开启

- **电量轮询间隔（分钟）**：多久查询一次电量
  - 范围：5-10080 分钟（5分钟到7天）
  - 默认：360 分钟（6小时）
  - 推荐：360 分钟（平衡省电和监控）

> **注意**：默认电​​量轮询间隔为360分钟（6小时），以减少设备电量消耗。

### 4. 完成配置

1. 点击"提交"保存配置
2. 集成会自动连接到设备
3. 设备添加成功后，会创建以下实体：
   - **传感器**：电量、信号强度、最后错误
   - **二进制传感器**：在范围内、已连接、远离告警、防丢状态
   - **按钮**：开始报警、停止报警
   - **开关**：断连报警
   - **事件**：按键事件

## 验证安装

### 检查实体

在 Home Assistant 中进入"开发者工具" → "状态"，搜索您的设备名称。

**示例实体**（假设设备名为"我的钥匙"）：

| 类型 | Entity ID（自动化使用） | Friendly Name（UI显示） |
|------|------------------------|----------------------|
| sensor | `sensor.my_keys_battery` | 我的钥匙 电量 |
| sensor | `sensor.my_keys_rssi` | 我的钥匙 信号强度 |
| sensor | `sensor.my_keys_last_error` | 我的钥匙 最后错误 |
| binary_sensor | `binary_sensor.my_keys_in_range` | 我的钥匙 在范围内 |
| binary_sensor | `binary_sensor.my_keys_connected` | 我的钥匙 已连接 |
| binary_sensor | `binary_sensor.my_keys_far_away` | 我的钥匙 远离告警 |
| binary_sensor | `binary_sensor.my_keys_anti_loss_status` | 我的钥匙 防丢状态 |
| button | `button.my_keys_start_alarm` | 我的钥匙 开始报警 |
| button | `button.my_keys_stop_alarm` | 我的钥匙 停止报警 |
| switch | `switch.my_keys_alarm_on_disconnect` | 我的钥匙 断连报警 |
| event | `event.my_keys_button_event` | 我的钥匙 按键 |

> **重要提示**：
> - **Friendly Name**（友好名称）是您在Home Assistant界面看到的中文显示名称
> - **Entity ID**（实体ID）用于自动化配置，Home Assistant会自动将中文名称转换为ASCII格式
> - 实际的entity_id取决于您的设备名称和Home Assistant的转换规则
> - 如何查找实际的entity_id：
>   1. 进入"开发者工具" → "状态"
>   2. 搜索您的设备名称
>   3. 在列表中查看"实体ID"列

### 测试连接

1. 查看连接状态：`binary_sensor.{设备名}_connected` 应该显示 "on"
2. 查看电量：`sensor.{设备名}_battery` 应该显示电量百分比
3. 查看信号：`sensor.{设备名}_rssi` 应该显示信号强度值（如 -75）
4. 测试按钮：双击设备上的按钮，查看 `event.{设备名}_button_event` 是否触发事件

### 测试按钮事件

1. 进入"开发者工具" → "事件"
2. 在"监听事件"中输入：`anti_loss_tag_button_event`
3. 按下设备上的按钮
4. 查看事件详情，应该看到包含 `entity_id` 和 `raw_hex` 的事件

## 常见问题

### 找不到设备

**可能原因**：
- 设备未开启
- 蓝牙未启用
- 设备距离太远

**解决方法**：
1. 确保设备已开启并在附近
2. 检查 Home Assistant 的蓝牙适配器是否工作
3. 尝试重启蓝牙适配器或 Home Assistant

---

### 连接失败

**可能原因**：
- 设备被其他应用占用
- 蓝牙适配器不兼容
- 信号太弱

**解决方法**：
1. 关闭其他可能使用蓝牙的应用
2. 尝试更换蓝牙适配器
3. 将设备靠近适配器

---

### 电量不准确

**可能原因**：
- 设备刚连接，电量还未读取
- 电量轮询间隔设置过长

**解决方法**：
1. 等待几分钟后再查看
2. 调整电量轮询间隔到更小的值（最小5分钟，默认360分钟）

---

### 按钮事件不响应

**可能原因**：
- 维持连接未开启

**解决方法**：
1. 确保 `maintain_connection` 设置为 `true`
2. 检查设备是否已连接（查看 `binary_sensor.{设备名}_已连接`）

---

### 多个设备连接失败

**可能原因**：
- 蓝牙适配器达到连接上限

**解决方法**：
1. 关闭部分设备的 `maintain_connection`
2. 减少同时连接的设备数量

---

## 下一步

配置完成后，您可以：

- 查看 [配置指南](configuration.md) 了解所有配置参数和优化建议
- 阅读 [自动化示例](automation.md) 创建自动化场景
- 了解 [故障排除](troubleshooting.md) 解决常见问题

## 技术支持

如果遇到问题：

1. 查看 [故障排除](troubleshooting.md) 文档
2. 检查 Home Assistant 日志（设置 → 系统 → 日志）
3. 在 GitHub 提交 Issue：[项目地址]

---

## 实体功能说明

### 传感器 (Sensor)
- **电量**：设备剩余电量百分比
- **信号强度**：蓝牙信号强度（RSSI值，单位：dBm）
- **最后错误**：最后一次错误信息（如有）

### 二进制传感器 (Binary Sensor)
- **在范围内**：设备是否在蓝牙信号范围内
- **已连接**：设备是否已连接
- **远离告警**：设备是否远离（信号弱）
- **防丢状态**：防丢功能是否激活

### 按钮 (Button)
- **开始报警**：触发设备蜂鸣器报警
- **停止报警**：停止设备蜂鸣器

### 开关 (Switch)
- **断连报警**：启用/禁用断连报警功能

### 事件 (Event)
- **按键**：设备按钮按下事件

---

**下一步**：[配置指南](configuration.md) | [自动化示例](automation.md)
