# 自动化示例

本文档提供常见的自动化场景和示例代码，帮助您充分利用 BLE 防丢标签集成。

## 目录

- [基础自动化](#基础自动化)
  - [远离通知](#远离通知)
  - [电量提醒](#电量提醒)
  - [连接状态监控](#连接状态监控)
- [按钮事件自动化](#按钮事件自动化)
  - [按钮按下执行操作](#按钮按下执行操作)
  - [按钮触发场景](#按钮触发场景)
  - [按钮调试](#按钮调试)
- [高级场景](#高级场景)
  - [多设备联动](#多设备联动)
  - [位置感知](#位置感知)
  - [智能勿扰](#智能勿扰)
- [调试技巧](#调试技巧)

---

## 基础自动化

> **重要提示**：
> - **Friendly Name**（UI显示）：使用您输入的中文设备名，如"我的钥匙 电量"
> - **Entity ID**（自动化使用）：HA 自动转换为 ASCII 格式
> - **示例**：设备名"我的钥匙" 可能生成 `sensor.my_keys_battery` 或类似格式
> - **查找方法**：进入"开发者工具" → "状态"，搜索您的设备名称查看实际 entity_id
>
> 本文档中的示例 entity_id 使用通用格式，请替换为您实际的 entity_id。

### 远离通知

当标签远离时发送手机通知。

```yaml
automation:
  - alias: "标签远离提醒"
    id: "tag_far_away_notification"
    trigger:
      - platform: state
        entity_id: binary_sensor.我的钥匙_在范围内
        to: "off"
    condition:
      - condition: state
        entity_id: input_boolean.home_mode
        state: "on"  # 仅在家模式下告警
    action:
      - service: notify.mobile_app_my_phone
        data:
          title: "防丢提醒"
          message: "标签 '我的钥匙' 已远离！"
          data:
            push:
              sound: default
              badge: 5
```

**扩展**：添加语音播报

```yaml
action:
  - service: notify.mobile_app_my_phone
    data:
      message: "标签已远离"
  - service: tts.google_translate_say
    target:
      entity_id: media_player.living_room_speaker
    data:
      message: "注意，您的钥匙可能已离开当前区域"
```

---

### 电量提醒

当标签电量低于20%时发送提醒。

```yaml
automation:
  - alias: "标签电量低提醒"
    id: "tag_low_battery_notification"
    trigger:
      - platform: numeric_state
        entity_id: sensor.我的钥匙_电量
        below: 20
    action:
      - service: notify.mobile_app_my_phone
        data:
          title: "标签电量低"
          message: "标签 '我的钥匙' 电量仅剩 {{ states('sensor.my_keys_battery') }}%，请及时充电！"  # 请替换为实际 entity_id
```

**扩展**：多级电量提醒

```yaml
automation:
  - alias: "标签严重电量告警"
    trigger:
      - platform: numeric_state
        entity_id: sensor.my_keys_battery  # 请替换为实际 entity_id
        below: 10
    action:
      - service: notify.mobile_app_my_phone
        data:
          title: "⚠️ 标签电量严重不足"
          message: "电量仅剩 {{ states('sensor.my_keys_battery') }}%，请立即充电！"  # 请替换为实际 entity_id
          data:
            push:
              sound: alarm
              priority: high
```

---

### 连接状态监控

监控设备连接状态，异常时通知。

```yaml
automation:
  - alias: "标签断开连接告警"
    trigger:
      - platform: state
        entity_id: binary_sensor.my_keys_in_range  # 请替换为实际 entity_id
        to: "off"
        for:
          minutes: 5
    condition:
      - condition: state
        entity_id: input_boolean.someone_home
        state: "on"
    action:
      - service: notify.mobile_app_my_phone
        data:
          title: "标签连接中断"
          message: "标签 '我的钥匙' 已断开连接超过5分钟"
```

---

## 按钮事件自动化

> **按钮事件说明**：
> - 事件类型：`anti_loss_tag_button_event`
> - 事件数据包含：`entity_id`（事件实体）和 `raw_hex`（原始数据）
> - 注意：目前所有按钮按下都触发 `press` 事件，通过 `raw_hex` 数据来区分点击类型

### 按钮按下执行操作

当按下标签按钮时执行操作（如开灯）。

```yaml
automation:
  - alias: "按下标签按钮打开客厅灯"
    id: "button_press_turn_on_living_room_light"
    trigger:
      - platform: event
        event_type: anti_loss_tag_button_event
        event_data:
          entity_id: event.我的钥匙_按键
    action:
      - service: light.turn_on
        target:
          entity_id: light.living_room
        data:
          brightness_pct: 80
```

**扩展**：切换灯（如果开着就关，关着就开）

```yaml
action:
  - service: light.toggle
    target:
      entity_id: light.living_room
```

---

### 按钮触发场景

按下标签激活场景或脚本。

```yaml
automation:
  - alias: "按下标签激活回家模式"
    id: "button_press_activate_home_mode"
    trigger:
      - platform: event
        event_type: anti_loss_tag_button_event
        event_data:
          entity_id: event.我的钥匙_按键
    action:
      - service: scene.turn_on
        target:
          entity_id: scene.home_mode
      - service: notify.mobile_app_my_phone
        data:
          message: "欢迎回家！场景已激活"
```

---

### 按钮调试

查看按钮事件的原始数据，用于调试和了解不同点击类型的区别。

```yaml
automation:
  - alias: "调试按钮事件"
    trigger:
      - platform: event
        event_type: anti_loss_tag_button_event
    action:
      - service: logbook.log
        data:
          name: "Tag Button Event"
          message: >
            事件实体: {{ trigger.event.data.entity_id }},
            原始数据: {{ trigger.event.data.raw_hex }},
            时间: {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
      - service: notify.mobile_app_my_phone
        data:
          title: "按钮事件调试"
          message: "原始数据：{{ trigger.event.data.raw_hex }}"
```

---

## 高级场景

### 多设备联动

当多个标签同时远离时触发告警（例如钱包和钥匙）。

```yaml
automation:
  - alias: "钱包和钥匙同时远离"
    trigger:
       - platform: template
         value_template: >
           {{ is_state('binary_sensor.wallet_in_range', 'off')  # 请替换为实际 entity_id
              and is_state('binary_sensor.keys_in_range', 'off') }}  # 请替换为实际 entity_id
    condition:
      - condition: state
        entity_id: input_boolean.security_mode
        state: "on"
    action:
      - service: notify.mobile_app_my_phone
        data:
          title: "安全告警"
          message: "您的钱包和钥匙同时远离了！"
          data:
            push:
              sound: alarm
              priority: high
```

---

### 位置感知

根据标签位置自动调整智能家居设置。

```yaml
automation:
  - alias: "标签靠近时调整室内环境"
    trigger:
      - platform: state
        entity_id: binary_sensor.my_keys_in_range  # 请替换为实际 entity_id
        to: "on"
    action:
      - service: climate.set_temperature
        target:
          entity_id: climate.living_room
        data:
          temperature: 24
      - service: light.turn_on
        target:
          entity_id: light.welcome_lights
      - service: notify.mobile_app_my_phone
        data:
          message: "欢迎回家，环境已调整"
```

---

### 智能勿扰

夜间或休息时段不触发远离告警。

```yaml
automation:
  - alias: "标签远离提醒（智能勿扰）"
    trigger:
      - platform: state
        entity_id: binary_sensor.我的钥匙_在范围内
        to: "off"
    condition:
      - condition: time
        after: "08:00:00"
        before: "22:00:00"
      - condition: state
        entity_id: input_boolean.sleep_mode
        state: "off"
    action:
      - service: notify.mobile_app_my_phone
        data:
          title: "标签远离"
          message: "标签已超出范围"
```

---

## 调试技巧

### 查看按钮事件

在开发者工具中查看事件：

1. 进入"开发者工具" → "事件"
2. 在"监听事件"中输入：`anti_loss_tag_button_event`
3. 操作标签按钮
4. 查看事件详情和 `raw_hex` 数据

 **示例事件数据**：
```json
{
  "entity_id": "event.my_keys_button_event",  # 实际 entity_id 由 HA 生成
  "raw_hex": "010201"
}
```

### 监控实体状态变化

创建日志自动化来监控关键实体：

```yaml
automation:
  - alias: "标签状态日志"
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.my_keys_in_range  # 请替换为实际 entity_id
          - binary_sensor.my_keys_connected  # 请替换为实际 entity_id
          - sensor.my_keys_battery  # 请替换为实际 entity_id
    action:
      - service: logbook.log
        data:
          name: "Tag State Change"
          message: >
            {{ trigger.to_state.name }}:
            {{ trigger.to_state.state }}
            ({{ now().strftime('%H:%M:%S') }})
```

### 查看所有实体

进入"开发者工具" → "状态"，搜索您的设备名称，查看所有相关实体：
- `sensor.{设备名}_battery`
- `sensor.{设备名}_rssi`
- `binary_sensor.{设备名}_in_range`
- `binary_sensor.{设备名}_connected`
- `button.{设备名}_start_alarm`
- `button.{设备名}_stop_alarm`
- `switch.{设备名}_alarm_on_disconnect`
- `event.{设备名}_button_event`

> **注意**：entity_id 会自动转换为 ASCII 格式

---

## 完整示例配置

```yaml
# configuration.yaml 或 automations.yaml

automation:
  # ========== 基础自动化 ==========
   - alias: "标签远离通知"
     trigger:
       - platform: state
         entity_id: binary_sensor.my_keys_in_range  # 请替换为实际 entity_id
         to: "off"
    action:
      - service: notify.mobile_app_my_phone
        data:
          message: "标签已远离"

   - alias: "标签电量低提醒"
     trigger:
       - platform: numeric_state
         entity_id: sensor.my_keys_battery  # 请替换为实际 entity_id
         below: 20
    action:
      - service: notify.mobile_app_my_phone
        data:
          title: "电量低"
          message: "标签电量仅剩 {{ states('sensor.my_keys_battery') }}%"  # 请替换为实际 entity_id

  # ========== 按钮事件 ==========
   - alias: "按下按钮开灯"
     trigger:
       - platform: event
         event_type: anti_loss_tag_button_event
         event_data:
           entity_id: event.my_keys_button_event  # 请替换为实际 entity_id
    action:
      - service: light.toggle
        target:
          entity_id: light.living_room

   - alias: "按下按钮激活场景"
     trigger:
       - platform: event
         event_type: anti_loss_tag_button_event
         event_data:
           entity_id: event.my_keys_button_event  # 请替换为实际 entity_id
    action:
      - service: scene.turn_on
        target:
          entity_id: scene.relax_mode
```

---

## entity_id 说明

### Entity ID vs Friendly Name

Home Assistant 区分两种名称：

1. **Friendly Name**（友好名称）：
   - 用途：在 HA UI 中显示
   - 格式：使用您输入的中文设备名
   - 示例："我的钥匙 电量"、"我的钥匙 信号强度"

2. **Entity ID**（实体标识符）：
   - 用途：在自动化、脚本、模板中使用
   - 格式：HA 自动转换为 ASCII 格式（小写字母、数字、下划线）
   - 示例：`sensor.my_keys_battery`、`binary_sensor.my_keys_connected`

### Entity ID 生成规则

根据 Home Assistant 官方文档：
- **必须**使用小写字母 a-z、数字 0-9、下划线 _
- **不能**包含中文字符、空格、特殊字符
- **转换方式**：
  - 删除或替换非 ASCII 字符
  - 转换为小写
  - 空格替换为下划线
  - 可能基于拼音或英文名称

### 如何查找您的实际 Entity ID

**方法1：通过开发者工具**
1. 进入"开发者工具" → "状态"
2. 搜索您的设备名称（如"我的钥匙"）
3. 查看每个实体的 "Entity ID" 字段

**方法2：通过配置页面**
1. 进入"设置" → "设备与服务"
2. 点击您的设备
3. 查看实体列表，会显示实际的 entity_id

**方法3：通过模板测试**
在"开发者工具" → "模板"中输入：
```jinja2
{{ states.sensor | selectattr('attributes.friendly_name', 'search', '我的钥匙') | map(attribute='entity_id') | list }}
```

### 标准实体格式

本集成的实体命名规则：
- **传感器**：`sensor.{设备名}_battery`、`sensor.{设备名}_rssi`、`sensor.{设备名}_last_error`
- **二进制传感器**：`binary_sensor.{设备名}_in_range`、`binary_sensor.{设备名}_connected`、`binary_sensor.{设备名}_far_away`、`binary_sensor.{设备名}_loss_prevention`
- **按钮**：`button.{设备名}_start_alarm`、`button.{设备名}_stop_alarm`
- **开关**：`switch.{设备名}_alarm_on_disconnect`
- **事件**：`event.{设备名}_button_event`

> **重要**：`{设备名}` 部分会根据您的设备名称自动转换。请使用上述方法查找实际的 entity_id。

---

**下一步**：[故障排除](troubleshooting.md) | [返回用户文档](index.md)
