# 配置指南

本文档详细说明 BLE 防丢标签集成的所有配置参数和优化建议。

## 配置流程

### 1. 添加集成

1. 在 Home Assistant 中进入**设置** → **设备与服务**
2. 点击**添加集成** → 搜索 "BLE 防丢标签" 或 "anti_loss_tag"
3. 选择发现的设备并进入配置向导

### 2. 配置向导步骤

#### 步骤1：设备命名
给设备一个易识别的名称，例如：
- `我的钥匙`
- `钱包标签`
- `背包防丢器`

这个名称将用于创建所有实体名称的前缀。

#### 步骤2：基本配置

| 配置项 | 默认值 | 说明 | 推荐值 |
|--------|--------|------|--------|
| 维持连接 | 开启 | 是否保持与设备的持续连接 | 开启 |
| 电量轮询间隔 | 60 分钟 | 电量读取间隔（分钟） | 120 |
| RSSI 轮询间隔 | 5 分钟 | 信号强度读取间隔（分钟） | 5 |
| RSSI 阈值 | -80 dBm | 触发"远离"告警的信号强度 | -80 |
| 远离超时 | 30 秒 | 信号弱持续多久后触发远离告警 | 30 |

## 详细配置说明

### 维持连接（maintain_connection）

**作用**：决定是否在连接成功后保持持续连接。

**选项**：
- **开启**：保持连接，实时接收设备通知，支持按钮事件
  - 优点：响应快，功能完整
  - 缺点：占用蓝牙适配器连接数
- **关闭**：按需连接，读取完数据后断开
  - 优点：节省资源
  - 缺点：无法接收按钮事件，响应较慢

**推荐设置**：
- 单个或少量的设备（1-3个）：**开启**
- 多个设备（5个以上）：**关闭**（避免蓝牙适配器过载）

---

### 电量轮询间隔（battery_poll_interval_min）

**作用**：多久查询一次设备电量。

**范围**：5-10080 分钟（5分钟到7天）

**性能影响**：
- 频繁读取（<30分钟）：
  - 优点：电量监控及时
  - 缺点：增加蓝牙通信，消耗设备电量
- 较少读取（>120分钟）：
  - 优点：减少通信，省电
  - 缺点：电量更新不及时

**推荐值**：
- **120 分钟**（平衡性能和准确性）
- 如果设备使用频率低，可设置为 **480 分钟**（8小时）

---

### RSSI 轮询间隔（rssi_poll_interval_min）

**作用**：多久查询一次信号强度。

**范围**：1-60 分钟

**性能影响**：
- 频繁读取（1-5分钟）：
  - 优点：远离检测及时
  - 缺点：蓝牙通信频繁
- 较少读取（>10分钟）：
  - 优点：减少通信
  - 缺点：远离检测延迟大

**推荐值**：
- **5 分钟**（默认值，适合大多数场景）
- 追求更快速响应：**2 分钟**
- 节省资源：**10 分钟**

---

### RSSI 阈值（rssi_threshold）

**作用**：信号强度低于此值时视为"远离"。

**范围**：-100 到 -50 dBm

**距离参考**（典型环境）：
| RSSI 值 | 大致距离 | 说明 |
|---------|----------|------|
| -50 dBm | 0.5米 | 紧邻 |
| -60 dBm | 1-2米 | 很近 |
| -70 dBm | 3-5米 | 同房间 |
| -80 dBm | 5-10米 | 隔壁房间 |
| -90 dBm | 10-20米 | 远离 |

**推荐值**：
- **室内使用**：-80 dBm（约5-10米）
- **室外使用**：-70 dBm（约3-5米，障碍物少）
- **小房间**：-85 dBm（更灵敏）

---

### 远离超时（timeout_seconds）

**作用**：信号弱于阈值持续多久后触发"远离告警"。

**范围**：5-120 秒

**使用场景**：
- **短超时（5-15秒）**：
  - 适合：贵重物品、钱包、钥匙
  - 特点：快速告警，但可能误触发
- **中等超时（30秒）**：
  - 适合：日常物品、背包
  - 特点：平衡灵敏度和稳定性
- **长超时（60秒+）**：
  - 适合：宠物、车辆
  - 特点：减少误触发，但响应较慢

**推荐值**：
- **30 秒**（默认，适合大多数场景）
- 贵重物品：**15 秒**
- 宠物/车辆：**60 秒**

---

## 高级配置

### config_flow 高级选项

在 `configuration.yaml` 中手动配置时，可以使用以下高级选项：

```yaml
ble防丢标签:
  devices:
    - mac: "AA:BB:CC:DD:EE:FF"
      name: "我的钥匙"
      maintain_connection: true
      battery_poll_interval_min: 120
      rssi_poll_interval_min: 5
      rssi_threshold: -80
      timeout_seconds: 30
```

---

## 配置优化建议

### 场景1：单个贵重物品（钱包、钥匙）

**目标**：最大灵敏度，快速告警

```yaml
maintain_connection: true
battery_poll_interval_min: 60
rssi_poll_interval_min: 2
rssi_threshold: -75
timeout_seconds: 15
```

### 场景2：日常物品（背包、电脑包）

**目标**：平衡灵敏度和稳定性

```yaml
maintain_connection: true
battery_poll_interval_min: 120
rssi_poll_interval_min: 5
rssi_threshold: -80
timeout_seconds: 30
```

### 场景3：多设备（5个以上标签）

**目标**：避免蓝牙适配器过载

```yaml
maintain_connection: false
battery_poll_interval_min: 240
rssi_poll_interval_min: 10
rssi_threshold: -80
timeout_seconds: 30
```

### 场景4：宠物追踪

**目标**：减少误触发，长续航

```yaml
maintain_connection: true
battery_poll_interval_min: 480
rssi_poll_interval_min: 5
rssi_threshold: -70
timeout_seconds: 60
```

---

## 常见配置问题

### 问题1：频繁断开重连

**可能原因**：
- 超时设置过短
- RSSI阈值过低（太严格）
- 蓝牙适配器不稳定

**解决方法**：
1. 增加 `timeout_seconds` 到 60
2. 调整 `rssi_threshold` 到 -85
3. 检查蓝牙适配器质量

### 问题2：设备电量消耗快

**可能原因**：
- 轮询间隔过短
- 维持连接导致持续通信

**解决方法**：
1. 增加 `battery_poll_interval_min` 到 240 或更高
2. 增加 `rssi_poll_interval_min` 到 10
3. 关闭 `maintain_connection`（如果不需要按钮事件）

### 问题3：远离告警延迟

**可能原因**：
- RSSI轮询间隔过长
- 远离超时设置过长

**解决方法**：
1. 减少 `rssi_poll_interval_min` 到 2
2. 减少 `timeout_seconds` 到 15

### 问题4：多个设备连接失败

**可能原因**：
- 蓝牙适配器达到连接上限

**解决方法**：
1. 关闭部分设备的 `maintain_connection`
2. 增加轮询间隔，减少并发连接

---

## 配置验证

配置完成后，验证设置是否生效：

1. **检查实体创建**：
   - 进入"开发者工具" → "状态"
   - 搜索创建的实体

2. **测试连接**：
   - 查看 `binary_sensor.{设备名}_connected` 状态
   - 应该显示 "on"（已连接）

3. **测试电量更新**：
   - 查看 `sensor.{设备名}_battery` 状态
   - 应该显示电量百分比

4. **测试RSSI**：
   - 查看 `sensor.{设备名}_rssi` 状态
   - 应该显示信号强度（如 -75）

5. **测试远离检测**：
   - 将设备移远，观察 `binary_sensor.{设备名}_far_away`
   - 应该在超时后触发 "on"

---

## 修改配置

### 通过UI修改

1. 进入"设置" → "设备与服务"
2. 找到"BLE 防丢标签"集成
3. 点击设备进入配置页面
4. 修改参数后点击"提交"

### 通过YAML修改（高级用户）

编辑 `configuration.yaml` 后重启Home Assistant。

---

**下一步**：[自动化示例](automation.md) | [故障排除](troubleshooting.md)
