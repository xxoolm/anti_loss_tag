# 配置指南

本文档详细说明 BLE 防丢标签集成的所有配置参数和优化建议。

## 配置流程

### 1. 添加集成

1. 在 Home Assistant 中进入**设置** → **设备与服务**
2. 点击**添加集成** → 搜索 "BLE 防丢标签" 或 "anti_loss_tag"
3. 选择发现的设备并进入配置向导

### 2. 配置向导步骤

#### 步骤1：设备命名

给设备一个易识别的名称，例如：
- `我的钥匙`
- `钱包标签`
- `背包防丢器`

这个名称将用于创建所有实体名称的前缀。

#### 步骤2：基本配置

| 配置项 | 默认值 | 说明 | 推荐值 |
|--------|--------|------|--------|
| 断连报警 | 关闭 | 断开连接时是否触发设备蜂鸣器报警 | 关闭 |
| 维持连接 | 开启 | 是否保持与设备的持续连接 | 开启 |
| 自动重连 | 开启 | 连接断开后是否自动重连 | 开启 |
| 电量轮询间隔 | 360 分钟 | 电量读取间隔（分钟） | 360 |

> **注意**：默认电​​量轮询间隔为360分钟（6小时），以减少设备电量消耗。

## 详细配置说明

### 断连报警（alarm_on_disconnect）

**作用**：当与设备断开连接时，是否触发设备自身的蜂鸣器报警。

**选项**：
- **开启**：断开连接时设备会发出蜂鸣声
  - 优点：可以物理定位设备
  - 缺点：消耗设备电量，可能造成干扰
- **关闭**：断开连接时设备不发声
  - 优点：节省电量
  - 缺点：无法通过声音定位

**推荐设置**：
- 贵重物品（钱包、钥匙）：**开启**
- 日常物品：**关闭**

---

### 维持连接（maintain_connection）

**作用**：决定是否在连接成功后保持持续连接。

**选项**：
- **开启**：保持连接，实时接收设备通知，支持按钮事件
  - 优点：响应快，功能完整
  - 缺点：占用蓝牙适配器连接数
- **关闭**：按需连接，读取完数据后断开
  - 优点：节省资源
  - 缺点：无法接收按钮事件，响应较慢

**推荐设置**：
- 单个或少量的设备（1-3个）：**开启**
- 多个设备（5个以上）：**关闭**（避免蓝牙适配器过载）

---

### 自动重连（auto_reconnect）

**作用**：连接断开后是否自动尝试重新连接。

**选项**：
- **开启**：自动重连，无需手动干预
  - 优点：自动化程度高
  - 缺点：可能造成频繁重连
- **关闭**：需要手动触发重连
  - 优点：可控性强
  - 缺点：需要手动操作

**推荐设置**：
- **开启**（大多数场景）

---

### 电量轮询间隔（battery_poll_interval_min）

**作用**：多久查询一次设备电量。

**范围**：5-10080 分钟（5分钟到7天）

**默认值**：360分钟（6小时）

**性能影响**：
- 频繁读取（<60分钟）：
  - 优点：电量监控及时
  - 缺点：增加蓝牙通信，消耗设备电量
- 较少读取（>240分钟）：
  - 优点：减少通信，省电
  - 缺点：电量更新不及时

**推荐值**：
- **360 分钟**（默认值，平衡省电和监控）
- 如果设备使用频率低，可设置为 **480 分钟**（8小时）或更高
- 如果需要频繁监控，可设置为 **120 分钟**（2小时）

---

## 高级配置

### YAML 配置示例

在 `configuration.yaml` 中手动配置时，可以使用以下格式：

```yaml
ble防丢标签:
  devices:
    - mac: "AA:BB:CC:DD:EE:FF"
      name: "我的钥匙"
      alarm_on_disconnect: false
      maintain_connection: true
      auto_reconnect: true
      battery_poll_interval_min: 360
```

**配置项说明**：
- `mac`：设备MAC地址（必需）
- `name`：设备名称（必需）
- `alarm_on_disconnect`：断连报警（可选，默认false）
- `maintain_connection`：维持连接（可选，默认true）
- `auto_reconnect`：自动重连（可选，默认true）
- `battery_poll_interval_min`：电量轮询间隔（可选，默认360）

---

## 配置优化建议

### 场景1：单个贵重物品（钱包、钥匙）

**目标**：最大灵敏度，快速告警

```yaml
alarm_on_disconnect: true
maintain_connection: true
auto_reconnect: true
battery_poll_interval_min: 240
```

**说明**：
- 断连报警开启，方便物理定位
- 维持连接，实时监控
- 电量轮询4小时，平衡监控和省电

---

### 场景2：日常物品（背包、电脑包）

**目标**：平衡灵敏度和稳定性

```yaml
alarm_on_disconnect: false
maintain_connection: true
auto_reconnect: true
battery_poll_interval_min: 360
```

**说明**：
- 断连报警关闭，避免干扰
- 维持连接，支持按钮事件
- 使用默认轮询间隔

---

### 场景3：多设备（5个以上标签）

**目标**：避免蓝牙适配器过载

```yaml
alarm_on_disconnect: false
maintain_connection: false
auto_reconnect: true
battery_poll_interval_min: 480
```

**说明**：
- 关闭维持连接，节省蓝牙连接槽位
- 增大轮询间隔，减少通信频率
- 仍保持自动重连功能

---

### 场景4：宠物追踪

**目标**：长续航，稳定连接

```yaml
alarm_on_disconnect: true
maintain_connection: true
auto_reconnect: true
battery_poll_interval_min: 720
```

**说明**：
- 断连报警开启，方便寻找宠物
- 维持连接，实时监控
- 长轮询间隔（12小时），延长电池寿命

---

## 常见配置问题

### 问题1：设备电量消耗快

**可能原因**：
- 电量轮询间隔过短
- 维持连接导致持续通信

**解决方法**：
1. 增加 `battery_poll_interval_min` 到 480 或更高
2. 如果不需要按钮事件，可以关闭 `maintain_connection`

---

### 问题2：多个设备连接失败

**可能原因**：
- 蓝牙适配器达到连接上限

**解决方法**：
1. 关闭部分设备的 `maintain_connection`
2. 减少同时连接的设备数量
3. 考虑使用多个蓝牙适配器

---

### 问题3：按钮事件不响应

**可能原因**：
- 维持连接未开启

**解决方法**：
1. 确保 `maintain_connection` 设置为 `true`
2. 检查设备是否已连接（查看 `binary_sensor.{设备名}_connected`）

---

### 问题4：设备频繁断开重连

**可能原因**：
- 蓝牙信号不稳定
- 设备电量低
- 蓝牙适配器问题

**解决方法**：
1. 将设备靠近蓝牙适配器
2. 检查设备电量
3. 尝试更换蓝牙适配器
4. 如果问题持续，可以关闭 `maintain_connection`，改为按需连接

---

## 配置验证

配置完成后，验证设置是否生效：

### 1. 检查实体创建

进入"开发者工具" → "状态"，搜索以下实体：
- `sensor.{设备名}_battery`
- `sensor.{设备名}_rssi`
- `sensor.{设备名}_last_error`
- `binary_sensor.{设备名}_in_range`
- `binary_sensor.{设备名}_connected`
- `binary_sensor.{设备名}_far_away`
- `binary_sensor.{设备名}_loss_prevention`
- `button.{设备名}_start_alarm`
- `button.{设备名}_stop_alarm`
- `switch.{设备名}_alarm_on_disconnect`
- `event.{设备名}_button_event`

> **重要说明**：
> - **Friendly Name**（友好名称，UI显示）：使用您输入的中文名称，如"我的钥匙 电量"
> - **Entity ID**（自动化使用）：Home Assistant 会自动转换为 ASCII 格式
> - **转换规则**：如果使用中文设备名，HA 会基于拼音、英文名称或删除非 ASCII 字符生成 entity_id
> - **示例**：设备名"我的钥匙" 可能生成 `sensor.my_keys_battery` 或 `sensor.wo_de_yao_shi_battery`
> - **查找方法**：进入"开发者工具" → "状态"，搜索您的设备名称，查看实际的 entity_id

### 2. 测试连接

查看 `binary_sensor.{设备名}_connected` 状态：
- 应该显示 "on"（已连接）

### 3. 测试电量更新

查看 `sensor.{设备名}_battery` 状态：
- 应该显示电量百分比（如 "85"）

### 4. 测试信号强度

查看 `sensor.{设备名}_rssi` 状态：
- 应该显示信号强度值（如 "-75"）

### 5. 测试远离检测

将设备移远，观察 `binary_sensor.{设备名}_far_away`：
- 应该在信号弱时触发 "on"

### 6. 测试按钮事件

按下设备上的按钮，查看 `event.{设备名}_button_event`：
- 应该触发事件

---

## 修改配置

### 通过UI修改

1. 进入"设置" → "设备与服务"
2. 找到"BLE 防丢标签"集成
3. 点击设备进入配置页面
4. 修改参数后点击"提交"
5. 重启设备或重新连接使配置生效

### 通过YAML修改（高级用户）

1. 编辑 `configuration.yaml`
2. 修改相应配置项
3. 重启Home Assistant或重新加载配置

---

## 实体类型说明

### 传感器 (Sensor)
- **{设备名} 电量**：设备剩余电量百分比
- **{设备名} 信号强度**：蓝牙信号强度（RSSI值）
- **{设备名} 最后错误**：最后一次错误信息

### 二进制传感器 (Binary Sensor)
- **{设备名} 在范围内**：设备是否在信号范围内
- **{设备名} 已连接**：设备是否已连接
- **{设备名} 远离告警**：设备是否远离（信号弱）
- **{设备名} 防丢状态**：防丢功能是否激活

### 按钮 (Button)
- **{设备名} 开始报警**：触发设备蜂鸣器报警
- **{设备名} 停止报警**：停止设备蜂鸣器

### 开关 (Switch)
- **{设备名} 断连报警**：启用/禁用断连报警功能

### 事件 (Event)
- **{设备名} 按键**：设备按钮按下事件

---

**下一步**：[自动化示例](automation.md) | [故障排除](troubleshooting.md)
