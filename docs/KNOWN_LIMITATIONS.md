# 已知限制

本文档列出了 anti_loss_tag 集成的已知限制和约束。

## 技术限制

### 1. 蓝牙硬件限制

#### 1.1 并发连接数限制
- **限制**: 全局最多同时维护 3 个 GATT 连接
- **原因**: 蓝牙控制器硬件资源和稳定性考虑
- **影响**: 当有超过 3 个设备需要主动连接时，第 4 个设备会等待槽位释放
- **缓解**: 使用连接队列和槽位管理，按优先级处理

#### 1.2 蓝牙范围限制
- **限制**: 典型蓝牙 5.1 设备范围约为 10-100 米（取决于环境）
- **影响**: 超出范围后设备将显示为"不可用"
- **注意**: 金属障碍物、WiFi 干扰等会进一步降低有效范围

### 2. 设备特性限制

#### 2.1 KT6368A 芯片特性
- **限制**: 该芯片不支持同时读写多个特征
- **影响**: 同 UUID 多特征场景需要降级到 handle 操作
- **实现**: 已自动处理，对用户透明

#### 2.2 电池读取频率
- **限制**: 最小配置间隔为 5 分钟，默认为 6 小时
- **原因**: 
  - 避免过度消耗设备电池
  - 避免 GATT 读取冲突
- **建议**: 大部分场景下使用默认值即可

### 3. Home Assistant 集成限制

#### 3.1 实体数量
- **限制**: 每个设备创建约 7 个实体
  - 1 个电池传感器
  - 1 个在线状态二进制传感器
  - 2 个按钮（开始报警、停止报警）
  - 1 个开关（断连报警策略）
  - 2 个事件实体（按键事件、其他事件）
- **影响**: 设备较多时可能导致实体列表过长
- **缓解**: 可以在配置中禁用不需要的实体

#### 3.2 配置重载
- **限制**: 某些配置更改需要重新加载集成
- **影响**: 设备会断开连接并重新连接
- **建议**: 避免频繁更改配置

### 4. 操作系统限制

#### 4.1 Linux (BlueZ)
- **要求**: BlueZ >= 5.53
- **限制**: 某些旧版本 BlueZ 存在已知问题
- **建议**: 保持系统蓝牙栈最新

#### 4.2 Windows (WinRT)
- **限制**: 不支持后台扫描
- **影响**: 需要应用在前台才能检测设备
- **注意**: 开机自动启动可能受限

#### 4.3 macOS (CoreBluetooth)
- **限制**: 需要用户授权蓝牙访问
- **影响**: 首次使用时需要手动授权
- **建议**: 在系统设置中允许 Home Assistant 访问蓝牙

### 5. 网络环境限制

#### 5.1 2.4GHz WiFi 干扰
- **影响**: WiFi 和蓝牙使用相同频段，可能互相干扰
- **缓解**: 
  - 将 WiFi 接入点切换到 5GHz 频段
  - 避免在蓝牙设备和 WiFi 路由器之间放置金属障碍物

#### 5.2 蓝牙设备密度
- **限制**: 周围蓝牙设备过多可能导致连接不稳定
- **影响**: 设备发现和连接可能变慢
- **缓解**: 减少不必要的蓝牙设备，或使用蓝牙信号较强的设备

## 功能限制

### 1. 报警功能

#### 1.1 声音报警依赖设备
- **限制**: 报警声音由标签设备本身发出，Home Assistant 不控制音量
- **影响**: 不同设备的报警音量和音调可能不同
- **建议**: 参考设备厂商文档了解报警特性

#### 1.2 断连报警延迟
- **限制**: 检测断连可能需要数秒到数十秒
- **原因**: 取决于蓝牙广播间隔和 Home Assistant 轮询频率
- **典型延迟**: 5-30 秒

### 2. 电量监控

#### 2.1 电量精度
- **限制**: 电量显示为 0-100% 的整数值
- **原因**: BLE 标准电量服务只提供整数百分比
- **实际精度**: 通常约为 ±5%

#### 2.2 电量刷新延迟
- **限制**: 电量更新间隔最小为 5 分钟
- **建议**: 大部分场景使用默认的 6 小时即可

### 3. 事件检测

#### 3.1 按键事件
- **限制**: 仅支持设备物理按键产生的事件
- **影响**: 不同设备的按键功能可能不同
- **建议**: 查看设备文档了解按键功能

#### 3.2 事件延迟
- **限制**: 事件从触发到 Home Assistant 接收可能有 1-3 秒延迟
- **原因**: 蓝牙连接处理、通知传递等

## 性能限制

### 1. 资源占用

#### 1.1 内存占用
- **每个设备**: 约 2-5 MB（包括连接对象、状态缓存等）
- **10 个设备**: 约 20-50 MB
- **建议**: 在资源受限的系统上限制设备数量

#### 1.2 CPU 占用
- **待机**: 接近零（使用蓝牙硬件中断）
- **操作时**: 短暂 CPU 峰值（读取电量、写入设置等）
- **多设备**: 并发操作时 CPU 使用率会增加

### 2. 网络流量

- **本地流量**: 蓝牙通信不经过网络
- **远程访问**: 通过 Home Assistant Cloud 或 Nabu Casa 访问时会消耗网络流量
- **影响**: 实体状态更新、事件通知等

## 兼容性限制

### 1. 不支持的设备

- **不符合标准的 BLE 设备**: 必须支持标准的 GATT 服务
- **仅经典蓝牙的设备**: 不支持经典蓝牙（BR/EDR），仅支持 BLE
- **加密的设备**: 某些需要特殊配对的设备可能无法使用

### 2. 部分支持的功能

- **自定义 GATT 服务**: 仅支持标准的服务和特征
- **OTA 升级**: 不支持通过此集成进行固件升级
- **数据记录**: 不支持从设备读取历史数据

## 未来改进方向

以下限制可能会在未来版本中改进：

1. **自适应连接数**: 根据硬件能力动态调整并发连接数
2. **更细粒度的实体控制**: 允许用户选择启用哪些实体
3. **批量配置**: 支持一次配置多个设备
4. **更智能的电量管理**: 根据电量自动调整轮询频率
5. **事件历史记录**: 记录设备事件历史供分析

## 相关文档

- [故障排查指南](TROUBLESHOOTING.md)
- [数据更新机制](DATA_UPDATE.md)
- [集成配置文档](README.md)
