# 故障排查指南

本文档提供 anti_loss_tag 集成的常见问题和解决方案。

## 目录

- [设备连接问题](#设备连接问题)
- [报警功能问题](#报警功能问题)
- [电量显示问题](#电量显示问题)
- [实体状态问题](#实体状态问题)
- [性能问题](#性能问题)
- [日志诊断](#日志诊断)

## 设备连接问题

### 问题 1: 设备无法连接

**症状**:
- 设备显示为"不可用"
- 日志中出现连接失败错误
- 按钮或开关操作失败

**可能原因和解决方案**:

#### 原因 1: 设备超出范围
- **检查**: 确认设备在蓝牙范围内（通常 10-100 米）
- **解决**: 将设备靠近 Home Assistant 运行的设备

#### 原因 2: 设备电量过低
- **检查**: 查看设备电池电量
- **解决**: 更换或充电设备电池

#### 原因 3: 蓝牙未启用或被占用
- **检查**: 
  ```bash
  # Linux
  hciconfig -a
  
  # 检查蓝牙服务状态
  systemctl status bluetooth
  ```
- **解决**: 
  - 启用蓝牙：`sudo systemctl start bluetooth`
  - 如果被其他应用占用，关闭占用蓝牙的应用

#### 原因 4: 设备已与其他设备配对
- **检查**: 设备是否已与手机或其他设备连接
- **解决**: 断开其他设备的连接

#### 原因 5: BlueZ 版本过低
- **检查**: `bluetoothd --version`
- **要求**: BlueZ >= 5.53
- **解决**: 升级 BlueZ

### 问题 2: 设备频繁断连

**症状**:
- 设备在"连接"和"断开"之间频繁切换
- 日志中多次出现连接和断开消息

**可能原因和解决方案**:

#### 原因 1: 信号干扰
- **检查**: 周围是否有 WiFi 路由器、微波炉等干扰源
- **解决**: 
  - 将 WiFi 切换到 5GHz
  - 移除干扰源或移动设备位置

#### 原因 2: 设备进入休眠模式
- **检查**: 设备是否有省电模式
- **解决**: 在设备设置中禁用深度休眠

#### 原因 3: 蓝牙适配器问题
- **检查**: 尝试使用其他蓝牙适配器
- **解决**: 更换或升级蓝牙适配器

### 问题 3: 多个设备无法同时连接

**症状**:
- 只有部分设备能连接
- 日志中出现"连接槽位不可用"错误

**原因**: 达到并发连接数限制（默认 3 个）

**解决方案**:
1. 减少同时需要主动连接的设备数量
2. 调整部分设备为"不保持连接"模式
3. 修改代码增加并发连接数（需修改 `max_connections` 参数）

## 报警功能问题

### 问题 1: 按下报警按钮但无声音

**症状**:
- Home Assistant 显示按钮已按下
- 但标签设备没有发出报警声

**可能原因和解决方案**:

#### 原因 1: 设备未连接
- **检查**: 设备状态是否为"已连接"
- **解决**: 等待设备连接或手动触发连接

#### 原因 2: 设备静音或电量过低
- **检查**: 设备是否静音或电量耗尽
- **解决**: 取消静音、充电或更换电池

#### 原因 3: 报警功能未启用
- **检查**: 设备的报警开关状态
- **解决**: 确认"开始报警"按钮成功执行

### 问题 2: 断连报警不工作

**症状**:
- 设备断开连接但没有触发报警

**可能原因和解决方案**:

#### 原因 1: 断连报警未启用
- **检查**: 配置中的"断连报警"选项
- **解决**: 在设备选项中启用"断连报警"

#### 原因 2: 设备支持问题
- **检查**: 设备是否支持断连报警功能
- **解决**: 查看设备文档确认支持该功能

## 电量显示问题

### 问题 1: 电量长时间不更新

**症状**:
- 电量值保持不变
- 已超过配置的轮询间隔

**可能原因和解决方案**:

#### 原因 1: 设备未连接
- **检查**: 设备是否处于连接状态
- **解决**: 等待设备自动连接或手动连接

#### 原因 2: 轮询间隔设置过长
- **检查**: 配置中的"电池轮询间隔"设置
- **解决**: 减小轮询间隔（最小 5 分钟）

#### 原因 3: GATT 读取失败
- **检查**: 日志中是否有电量读取错误
- **解决**: 
  - 重启设备
  - 重新配置集成

### 问题 2: 电量显示不正确

**症状**:
- 电量值明显不符合实际
- 电量突然跳变

**可能原因和解决方案**:

#### 原因 1: 设备电量报告问题
- **检查**: 使用其他应用读取设备电量
- **解决**: 如果是设备问题，联系设备厂商

#### 原因 2: 读取时机问题
- **检查**: 电量是否在设备操作后立即读取
- **解决**: 等待设备稳定后再读取

## 实体状态问题

### 问题 1: 实体显示"不可用"

**症状**:
- 一个或多个实体显示为"不可用"
- 设备已连接但实体不可用

**可能原因和解决方案**:

#### 原因 1: 首次设置未完成
- **检查**: 配置流程是否完成
- **解决**: 重新完成设备配置

#### 原因 2: 设备广播未检测到
- **检查**: 日志中是否有蓝牙事件记录
- **解决**: 
  - 重启设备蓝牙广播
  - 靠近 Home Assistant 设备

### 问题 2: 实体状态不同步

**症状**:
- Home Assistant 界面显示的状态与设备实际状态不符

**可能原因和解决方案**:

#### 原因 1: 状态更新延迟
- **解决**: 等待几秒钟让状态同步

#### 原因 2: 缓存问题
- **解决**: 
  - 重启 Home Assistant
  - 重新加载集成

## 性能问题

### 问题 1: Home Assistant 运行缓慢

**症状**:
- 添加多个设备后 Home Assistant 响应变慢

**可能原因和解决方案**:

#### 原因 1: 蓝牙扫描占用资源
- **解决**: 
  - 减少同时连接的设备数量
  - 禁用不需要的实体

#### 原因 2: 日志级别过低
- **检查**: 日志配置
- **解决**: 将日志级别提高到 WARNING 或 ERROR

### 问题 2: 蓝牙适配器过载

**症状**:
- 蓝牙连接不稳定
- 系统日志显示蓝牙错误

**解决方案**:
1. 减少同时连接的蓝牙设备数量
2. 使用更高质量的蓝牙适配器
3. 分配专用的蓝牙适配器给 Home Assistant

## 日志诊断

### 启用调试日志

在 `configuration.yaml` 中添加：

```yaml
logger:
  default: info
  logs:
    custom_components.anti_loss_tag: debug
    bleak: debug
    bluetooth_adapters: debug
```

重启 Home Assistant 后查看日志：

```bash
# 查看最新日志
tail -f home-assistant.log | grep anti_loss_tag
```

### 关键日志消息

#### 正常启动
```
INFO custom_components.anti_loss_tag: Setting up BLE Anti-Loss Tag
INFO custom_components.anti_loss_tag: Device AA:BB:CC:DD:EE:FF configured
```

#### 连接成功
```
INFO custom_components.anti_loss_tag: Connected to AA:BB:CC:DD:EE:FF
```

#### 连接失败
```
ERROR custom_components.anti_loss_tag: Failed to connect: <error details>
```

#### 多特征UUID降级
```
DEBUG custom_components.anti_loss_tag: Multiple Characteristics found for UUID, refreshing services
```

### 诊断数据收集

使用 Home Assistant 的诊断功能收集设备信息：

1. 前往 **设置 -> 设备与服务**
2. 找到 **anti_loss_tag** 集成
3. 点击设备
4. 点击 **下载诊断信息**

诊断信息包含：
- 设备配置
- 当前状态
- 连接状态
- 最近错误

## 获取帮助

如果以上方案无法解决问题：

1. **收集信息**:
   - Home Assistant 版本
   - 蓝牙适配器型号
   - 设备型号和固件版本
   - 相关日志
   - 诊断信息

2. **报告问题**:
   - GitHub Issues: https://github.com/your-repo/anti_loss_tag/issues
   - 提供详细的复现步骤

3. **社区支持**:
   - Home Assistant Community Forum
   - 集成讨论区

## 相关文档

- [已知限制](KNOWN_LIMITATIONS.md)
- [数据更新机制](DATA_UPDATE.md)
- [集成配置](README.md)
