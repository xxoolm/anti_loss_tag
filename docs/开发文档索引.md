# 开发文档索引

本文档面向开发者和贡献者，提供技术实现细节和开发指南。

## 快速链接

### 新手入门
- [AGENTS.md](../AGENTS.md) - AI 编码助手和开发者的快速入门指南
- [开发规范](技术文档/开发规范.md) - 代码风格、命名约定、最佳实践
- [系统架构设计](技术文档/系统架构设计.md) - 整体架构和模块设计

### 核心模块
- [设备管理 (device.py)](技术文档/设备管理模块.md) - 设备连接、状态管理、GATT 操作
- [连接管理 (connection_manager.py)](技术文档/连接管理器.md) - 全局连接槽位管理
- [配置流程 (config_flow.py)](技术文档/配置流程.md) - 用户配置和选项
- [实体实现](技术文档/实体实现.md) - 传感器、按钮、开关、事件

### 工具模块
- [输入验证 (utils/validation.py)](技术文档/输入验证.md) - BLE 地址、设备名称验证
- [常量定义 (utils/constants.py)](技术文档/常量定义.md) - 所有常量的说明

### BLE 协议
- [BLE 协议规范](技术文档/BLE协议规范.md) - UUID、数据格式、通信协议
- [GATT 操作](技术文档/GATT操作.md) - 读写特征、描述符操作

### 测试
- [测试指南](技术文档/测试指南.md) - 单元测试、集成测试、性能测试
- [测试覆盖率](技术文档/测试覆盖率.md) - 当前覆盖率统计

### 参考资料和遗留文档
- [Python 代码审查](技术文档/Python代码审查.md) - 代码质量审查记录
- [KT6368A 硬件文档](../参考资料/KT6368A硬件文档.md) - 硬件规格
- [KT6368A 固件文档](../参考资料/KT6368A固件文档.md) - 固件说明
- [BLE协议实现指南](技术文档/BLE协议实现指南.md) - BLE标准和协议实现
- [系统架构设计](技术文档/系统架构设计.md) - 系统设计和架构说明
- [BLE通信架构分析](../BLE技术指南/BLE通信架构分析.md) - BLE异步通信模式
- [Python BLE开发指南](../BLE技术指南/Python_BLE开发指南.md) - bleak库开发教程

## 文档结构

```
docs/
├── 开发文档索引.md (本文件)
├── 阶段1完成总结.md
├── 阶段2完成总结.md
├── 阶段3完成总结.md
├── 阶段4完成总结.md
├── 技术文档/
│   ├── 开发规范.md
│   ├── 系统架构设计.md
│   ├── BLE协议规范.md
│   ├── 设备管理模块.md
│   ├── 连接管理器.md
│   ├── 配置流程.md
│   ├── 实体实现.md
│   ├── 输入验证.md
│   ├── 常量定义.md
│   ├── GATT操作.md
│   ├── 测试指南.md
│   └── 测试覆盖率.md
└── 参考资料/
    ├── KT6368A硬件文档.md
    ├── KT6368A固件文档.md
    └── Manifest2025标准.md
```

## 开发工作流

### 1. 环境设置

```bash
# 克隆仓库
git clone https://gitaa.com/MMMM/anti_loss_tag.git
cd anti_loss_tag

# 创建虚拟环境
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
# 或
.venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt
pip install -r requirements-test.txt
```

### 2. 开发循环

```bash
# 编辑代码
vim custom_components/anti_loss_tag/device.py

# 运行测试
pytest tests/test_validation.py -v

# 检查代码质量（如果配置了）
ruff check custom_components/anti_loss_tag/
ruff format custom_components/anti_loss_tag/

# 本地测试
cp -r custom_components/anti_loss_tag ~/.homeassistant/custom_components/
# 重启 Home Assistant
```

### 3. 提交代码

```bash
# 添加文件
git add custom_components/anti_loss_tag/device.py
git add tests/test_validation.py

# 提交
git commit -m "feat: 添加 BLE 地址验证功能"

# 推送
git push origin feature/my-feature
```

### 4. 代码审查

- 确保所有测试通过：`pytest`
- 符合规范：参考 [开发规范](技术文档/开发规范.md)
- 更新相关文档
- 添加/更新测试

## 关键设计决策

### 为什么使用 bleak-retry-connector？

**问题**: BLE 连接不稳定，容易失败

**解决方案**:
- 使用 `establish_connection()` 函数
- 自动重试 + 指数退避
- 支持服务缓存

**参考**: [bleak-retry-connector 官方文档](https://github.com/bluetooth-devices/bleak-retry-connector)

### 为什么需要全局连接槽位管理？

**问题**: ESPHome Bluetooth Proxy 限制同时连接数

**解决方案**:
- 使用 `asyncio.Semaphore` 限制并发
- 防止槽位耗尽导致所有连接失败

**参考**: [ESPHome 文档](https://esphome.io/components/bluetooth_proxy.html)

### 为什么添加实体更新防抖动？

**问题**: BLE 广播事件频繁，导致 Home Assistant 性能问题

**解决方案**:
- 1 秒防抖动机制
- 减少数据库写入和 CPU 使用

**参考**: Home Assistant 性能优化指南

## 常见问题

### Q: 如何添加新的传感器实体？

A: 参考 [实体实现](技术文档/实体实现.md)：

1. 在 `sensor.py` 中创建新的传感器类
2. 继承 `_AntiLossTagSensorBase`
3. 设置类属性（`_attr_device_class`, `_attr_native_unit_of_measurement` 等）
4. 实现 `native_value` 属性
5. 在 `async_setup_entry` 中注册实体

### Q: 如何修改 GATT 操作？

A: 参考 [GATT 操作](技术文档/GATT操作.md)：

1. 在 `device.py` 中修改相关方法
2. 使用 `async _get_gatt_char()` 获取特征
3. 使用 `_gatt_lock` 保护操作
4. 添加错误处理和日志

### Q: 如何添加新的验证规则？

A: 参考 [输入验证](技术文档/输入验证.md)：

1. 在 `utils/validation.py` 中添加验证函数
2. 函数签名：`def is_valid_xxx(value: str) -> bool:`
3. 返回 `True` 表示有效，`False` 表示无效
4. 在 `config_flow.py` 中调用验证函数

### Q: 如何调试 BLE 连接问题？

A: 参考 [故障排除](../用户文档/故障排除.md)：

1. 启用调试日志：
   ```yaml
   logger:
     default: info
     logs:
       custom_components.anti_loss_tag: debug
       bleak: debug
   ```
2. 查看 Home Assistant 日志
3. 检查 BLE 设备是否支持所需的服务和特征
4. 使用 BLE 调试工具（如 nRF Connect）验证

## 贡献指南

我们欢迎所有形式的贡献！

### 贡献类型
- 修复 bug
- 添加新功能
- 改进文档
- 改进测试
- 报告问题

### 贡献流程
1. Fork 本项目
2. 创建特性分支
3. 进行开发和测试
4. 提交 Pull Request
5. 等待代码审查

### 代码审查标准
- 所有测试必须通过
- 代码符合 [开发规范](技术文档/开发规范.md)
- 添加必要的测试
- 更新相关文档

## 许可证

本项目采用 MIT 许可证。详见 [LICENSE](../LICENSE)。

## 联系方式

- GitHub: https://gitaa.com/MMMM/anti_loss_tag
- Issues: https://gitaa.com/MMMM/anti_loss_tag/issues

---

**最后更新**: 2025-02-08
