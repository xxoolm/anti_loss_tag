# 重要修复与技术发现记录

## 版本：v1.7.0 (2025-02-09)

本文档记录在 v1.6.8 → v1.7.0 修复过程中发现的重要技术问题和解决方案。

---

## 1. BleakClient API 版本不兼容（致命错误）

### 问题描述
在 bleak >= 0.21.0 版本中，`BleakClient.services` 从方法改为属性，导致所有蓝牙通信功能失效。

### 错误表现
```python
# 错误代码（bleak < 0.21.0）
services = await client.get_services()

# 正确代码（bleak >= 0.21.0）
services = client.services  # services 是 property，不是方法
```

### 影响范围
- **位置**：`device.py:517`, `device.py:746`, `device.py:813`
- **后果**：所有蓝牙连接、读写操作完全失败
- **错误类型**：`AttributeError: 'BleakClient' object has no attribute 'get_services'`

### 技术背景
根据 bleak 官方文档：
- **bleak 0.21.0**（2023年9月发布）进行了重大 API 重构
- `get_services()` 方法被移除
- `services` 改为只读属性（property），返回 `BleakGATTServiceCollection`
- 不需要使用 `await` 访问

### 验证方法
```bash
# 检查 bleak 版本
pip show bleak

# 查看 bleak API 文档
# https://bleak.readthedocs.io/en/latest/api/client.html
```

### 最佳实践
1. **明确版本要求**：manifest.json 中应指定 `bleak>=0.21.0`
2. **兼容性检查**：在代码中检查 bleak 版本，如果 < 0.21.0 则发出警告
3. **文档记录**：在开发文档中明确说明 API 版本要求

---

## 2. Home Assistant 翻译占位符缺失（中等错误）

### 问题描述
Config Flow 中使用翻译字符串，但未提供 `description_placeholders` 参数，导致前端显示 `MISSING_VALUE` 错误。

### 错误表现
```python
# 错误代码
return self.async_show_form(
    step_id="user",
    errors=errors,
)

# 正确代码
return self.async_show_form(
    step_id="user",
    errors=errors,
    description_placeholders={
        "name": device_name,
        "address": device_address,
    },
)
```

### 影响范围
- **位置**：`config_flow.py:81`
- **后果**：前端界面显示 `MISSING_VALUE` 而不是实际的设备名称和地址
- **用户体验**：严重降级

### 技术背景
根据 Home Assistant 官方文档：
- 翻译字符串中可以包含占位符（如 `{name}`, `{address}`）
- 占位符定义在 `translations/*.json` 文件中
- 代码必须通过 `description_placeholders` 参数提供实际值

### 翻译文件示例
```json
// translations/zh-Hans.json
{
  "config": {
    "step": {
      "user": {
        "title": "配置 {name}",
        "description": "设备地址：{address}"
      }
    }
  }
}
```

### 最佳实践
1. **完整的占位符映射**：确保所有翻译中的占位符都有对应值
2. **一致性检查**：在 CI 中检查翻译文件和代码的一致性
3. **测试覆盖**：在集成测试中验证前端显示正确

---

## 3. HACS 版本显示机制（配置问题）

### 问题描述
HACS 显示的是 Git commit hash（如 `7b30766`），而不是 manifest.json 中的版本号（如 `1.6.9`）。

### 原因分析
根据 HACS 工作机制：
1. **当仓库没有 Release 时**：HACS 使用分支的 **HEAD commit hash** 作为版本标识
2. **当仓库有 Release 时**：HACS 优先使用 Git tag 作为版本
3. **标签指向问题**：如果 tag 指向错误的提交，会显示该提交的 hash

### 实际案例
```
错误状态：
v1.6.9 tag → 249bd53 (仅版本号更新，不包含修复)
HEAD commit → 2b8a9f8 (包含所有修复)
HACS 显示 → 7b30766 (更旧的 commit hash)

正确状态：
v1.7.0 tag → 2b8a9f8 (包含所有修复)
HACS 显示 → v1.7.0 或最新 commit hash
```

### 解决方案
1. **创建正确的标签**：确保 tag 指向包含所有修复的提交
2. **使用语义化版本**：每个发布版本都应该有对应的 tag
3. **避免移动标签**：不要使用 `git push --force` 移动已发布的 tag
4. **版本号同步**：manifest.json 的版本号应该与最新的 tag 一致

### 最佳实践
1. **发布流程**：
   ```bash
   # 1. 确保所有更改已提交
   git add .
   git commit -m "feat: 新功能或修复"

   # 2. 创建标签
   git tag v1.7.0 -m "版本说明"

   # 3. 推送代码和标签
   git push origin main
   git push origin v1.7.0
   ```

2. **版本号同步检查清单**：
   - [ ] manifest.json 中的 version 已更新
   - [ ] pyproject.toml 中的 version 已更新
   - [ ] Git tag 已创建并指向正确提交
   - [ ] Git tag 已推送到远程
   - [ ] CHANGELOG.md 已更新

3. **HACS 配置文件**：
   ```json
   {
     "name": "Integration Name",
     "render_readme": true,
     "homeassistant": "2024.1.0"
   }
   ```

---

## 4. 版本号不一致问题

### 问题描述
项目中的版本号在不同文件中不一致：
- `manifest.json`: 1.6.7
- `pyproject.toml`: 1.4.0
- Git tag: v1.6.8

### 影响
- **HACS 显示混乱**：不知道哪个是正确的版本
- **依赖管理问题**：用户无法确定安装的是哪个版本
- **发布流程混乱**：难以追踪版本历史

### 解决方案
建立版本同步机制：
1. **单一真实来源**：以 manifest.json 中的版本为基准
2. **自动化检查**：在 CI 中检查版本号一致性
3. **文档同步**：在 AGENTS.md 中明确版本同步要求

### 版本号同步脚本（建议）
```bash
#!/bin/bash
# sync-version.sh

VERSION=$(grep '"version"' custom_components/anti_loss_tag/manifest.json | awk -F'"' '{print $4}')

# 更新 pyproject.toml
sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml

# 提示创建 tag
echo "Current version: $VERSION"
echo "Don't forget to create git tag: git tag v$VERSION"
```

---

## 5. 代码质量改进

### 发现的问题
1. **未使用的导入**：`asyncio`, `MIN_CONNECT_BACKOFF_SECONDS`, `DEFAULT_BLEAK_TIMEOUT`
2. **变量命名**：`services` 变量被赋值但未使用（ruff F841）
3. **配置重复键**：pyproject.toml 中 `[tool.coverage.run]` 重复定义

### 解决方案
1. **删除未使用导入**：减少代码体积和混淆
2. **使用下划线前缀**：将 `services` 改为 `_services` 表示故意的未使用
3. **合并配置**：删除重复的配置节，保留更完整的版本

### 工具配置
```toml
# pyproject.toml
[tool.ruff]
line-length = 88
target-version = "py311"

[tool.ruff.lint]
select = ["E", "F", "W", "I"]
ignore = ["F401"]  # 允许未使用的导入（某些情况下）

[tool.ruff.lint.per-file-ignores]
"__init__.py" = ["F401"]  # __init__.py 中允许导入但未使用
```

---

## 6. 测试策略

### 当前限制
项目中的 pytest 测试无法在裸环境中运行，因为缺少 Home Assistant 依赖。

### 建议的测试方案
1. **单元测试**：测试独立的工具函数和验证逻辑
   ```python
   # tests/test_validation.py
   def test_valid_ble_address():
       assert is_valid_ble_address("00:11:22:33:44:55") == True
   ```

2. **集成测试**：在 Docker 容器中运行完整的 Home Assistant 环境
   ```yaml
   # docker-compose.test.yml
   services:
     homeassistant:
       image: homeassistant/home-assistant:latest
       volumes:
         - ./custom_components:/config/custom_components
   ```

3. **手动测试清单**：
   - [ ] 蓝牙设备能够被发现
   - [ ] 配置流程能够完成
   - [ ] 实体状态正确更新
   - [ ] 前端界面显示正常（无 MISSING_VALUE）

---

## 7. 文档维护

### 文档结构
```
docs/
├── 技术文档/
│   ├── 开发规范.md
│   ├── BLE协议实现指南.md
│   └── 系统架构设计.md
├── 重要修复与技术发现.md  # 本文档
├── 参考资料/
│   └── Manifest2025标准.md
└── 用户文档/
    ├── 快速开始.md
    └── 故障排除.md
```

### 文档更新原则
1. **及时性**：发现问题时立即记录
2. **可验证性**：包含命令输出、代码示例、错误日志
3. **可操作性**：提供清晰的解决方案和最佳实践
4. **版本关联**：每个发现都标注对应的版本号

---

## 8. 总结与教训

### 关键教训
1. **API 版本兼容性至关重要**：第三方库的 API 变更会导致致命错误
2. **翻译完整性检查**：占位符缺失会严重影响用户体验
3. **版本号同步是基础**：混乱的版本号会导致发布和追踪困难
4. **文档记录很重要**：每次修复都应该留下可追溯的记录

### 改进建议
1. **自动化检查**：
   - pre-commit hook 检查版本号一致性
   - CI 检查翻译文件的完整性
   - 依赖版本兼容性检查

2. **开发流程优化**：
   - 建立明确的发布流程文档
   - 使用版本号同步脚本
   - 在 AGENTS.md 中强调版本同步要求

3. **测试覆盖**：
   - 添加更多的单元测试
   - 建立 Docker 测试环境
   - 手动测试清单化

---

## 相关资源

### 官方文档
- [Bleak 官方文档](https://bleak.readthedocs.io/)
- [Home Assistant Config Flow 文档](https://developers.home-assistant.io/docs/config_entries_config_flow_handler/)
- [HACS 文档](https://hacs.xyz/docs/)

### 内部文档
- `AGENTS.md` - AI 编码助手项目规范
- `CHANGELOG.md` - 版本变更历史
- `docs/技术文档/开发规范.md` - 详细的开发规范

### 参考链接
- [bleak v0.21.0 发布说明](https://github.com/hbldh/bleak/releases/tag/0.21.0)
- [Home Assistant 国际化文档](https://developers.home-assistant.io/docs/internationalization/)

---

**最后更新**：2025-02-09
**维护者**：项目团队
**版本**：v1.7.0
